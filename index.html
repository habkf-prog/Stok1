<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù„ÙˆØ­Ø© ØªØ³ÙŠÙŠØ± Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</title>

<style>
:root{
  --bg:#0b0f17; --card:#ffffff10; --line:#ffffff20; --text:#e9eef7; --muted:#b7bfd0;
  --accent:#7c5cff; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --radius:16px;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--bg);color:var(--text);padding:18px}
.container{max-width:1150px;margin:auto}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:16px}
h1{margin:0 0 8px;font-size:20px}
.small{color:var(--muted);font-size:12px}

.row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;align-items:center}
.btn{padding:11px 14px;border-radius:14px;border:1px solid var(--line);background:#00000040;color:var(--text);font-weight:900;cursor:pointer}
.btn.primary{border-color:var(--accent);background:linear-gradient(135deg,var(--accent),#4f46e5)}
.btn.danger{border-color:#ef444466}
input,select,textarea{width:100%;padding:11px 12px;border-radius:12px;border:1px solid var(--line);background:#00000040;color:var(--text)}

.badge{padding:4px 10px;border-radius:999px;font-size:12px;font-weight:900;border:1px solid var(--line)}
.badge.ok{border-color:#22c55e55;color:#c9f7d7}
.badge.warn{border-color:#f59e0b55;color:#ffe2b3}
.badge.err{border-color:#ef444455;color:#ffd0d0}

table{width:100%;border-collapse:collapse;margin-top:14px}
th,td{padding:10px;border-bottom:1px solid var(--line);white-space:nowrap;vertical-align:middle}
th{color:var(--muted);text-align:right}

/* ØµÙ Ù…Ù†ØªÙ‡ÙŠ (Ø£Ø­Ù…Ø±) */
tr.expired-row{background:rgba(239,68,68,.12)}
tr.expired-row td:first-child{box-shadow:inset 4px 0 0 rgba(239,68,68,.75)}

/* ØµÙ Ù‚Ø±ÙŠØ¨ ÙŠÙ†ØªÙ‡ÙŠ (Ø£ØµÙØ±) */
tr.expiring-row{background:rgba(245,158,11,.10)}
tr.expiring-row td:first-child{box-shadow:inset 4px 0 0 rgba(245,158,11,.75)}

/* Ù‚Ø§Ø¦Ù…Ø© â‹¯ Ù„ÙƒÙ„ ØµÙ */
.menuWrap{position:relative;display:inline-block}
.iconBtn{
  width:42px;height:38px;border-radius:12px;
  border:1px solid var(--line);
  background:#00000040;color:var(--text);
  cursor:pointer;font-weight:900;
}
.menu{
  position:absolute; inset:auto 0 0 auto;
  transform:translateY(42px);
  min-width:180px;
  background:#0b0f17;
  border:1px solid var(--line);
  border-radius:14px;
  padding:6px;
  display:none;
  z-index:1000;
  box-shadow:0 18px 45px rgba(0,0,0,.45);
}
.menu button{
  width:100%;
  padding:10px 10px;
  border-radius:12px;
  border:1px solid transparent;
  background:transparent;
  color:var(--text);
  text-align:right;
  cursor:pointer;
  font-weight:800;
}
.menu button:hover{background:#ffffff10;border-color:var(--line)}
.menu .danger{color:#ffd0d0}

/* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ */
details{
  margin-top:10px;
  border:1px solid var(--line);
  border-radius:14px;
  background:#00000026;
  padding:10px 12px;
}
summary{cursor:pointer;font-weight:900}

/* Modal Ø¹Ø§Ù… */
.modal{
  position:fixed; inset:0;
  background:rgba(0,0,0,.55);
  display:none; align-items:center; justify-content:center;
  z-index:9999;
}
.modal .box{
  width:min(720px,92vw);
  background:#0b0f17;
  border:1px solid var(--line);
  border-radius:18px;
  padding:16px;
  box-shadow:0 20px 60px rgba(0,0,0,.5);
}
.modal h2{margin:0 0 10px;font-size:18px}
.grid{
  display:grid;
  grid-template-columns: 1.2fr 1.2fr .8fr .8fr .8fr .8fr;
  gap:10px;
}
@media (max-width:980px){.grid{grid-template-columns:1fr 1fr}}
label{display:block;font-weight:900;margin:8px 0 6px}
.hr{height:1px;background:var(--line);margin:10px 0}
</style>
</head>

<body>
<div class="container">
  <div class="card">
    <h1>ğŸ§¾ Ù„ÙˆØ­Ø© ØªØ³ÙŠÙŠØ± Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</h1>
    <div class="small">âœ… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ â€œØ¥Ø¶Ø§ÙØ©â€. Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ + ØªÙ†Ø¨ÙŠÙ‡ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡.</div>

    <div class="row">
      <button class="btn primary" id="openAdd">â• Ø¥Ø¶Ø§ÙØ©</button>
      <input id="search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„..." style="flex:1;min-width:220px">
      <button class="btn danger" id="clearBtn">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
      <div class="small" id="stats" style="margin-inline-start:auto"></div>
    </div>

    <details>
      <summary>ğŸ“¦ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ (ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯)</summary>
      <div class="row">
        <button class="btn" id="exportJsonBtn">â¬‡ï¸ JSON</button>
        <button class="btn" id="importFileBtn">â¬†ï¸ Ù…Ù„Ù JSON</button>
        <button class="btn" id="importPasteBtn">ğŸ“‹ Ù„ØµÙ‚ JSON</button>
        <button class="btn" id="exportCsvBtn">â¬‡ï¸ CSV</button>
        <input id="fileInput" type="file" accept="application/json,.json" style="display:none">
      </div>
      <div class="small">ØµØ¯Ù‘Ø± JSON Ø¯ÙˆØ±ÙŠÙ‹Ø§ Ù„Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.</div>
    </details>

    <table>
      <thead>
        <tr>
          <th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</th>
          <th>Ø§Ù„Ù…Ø¯Ø©</th>
          <th>Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th>
          <th>Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th>
          <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <th>â‹¯</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<!-- Modal Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ -->
<div class="modal" id="formModal" aria-hidden="true">
  <div class="box">
    <h2 id="formTitle">Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ùƒ</h2>
    <div class="small">Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø«Ù… Ø§Ø¶ØºØ· Ø­ÙØ¸.</div>
    <div class="hr"></div>

    <div class="grid">
      <div>
        <label>Ø§Ù„Ø§Ø³Ù…</label>
        <input id="name" placeholder="Ù…Ø«Ø§Ù„: Ahmed">
      </div>
      <div>
        <label>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label>
        <input id="email" placeholder="name@example.com" inputmode="email">
      </div>
      <div>
        <label>Ø§Ø®ØªÙŠØ§Ø± Ø³Ø±ÙŠØ¹</label>
        <select id="quickPlan">
          <option value="">â€” Ø§Ø®ØªØ± â€”</option>
          <option value="1">1 Ø´Ù‡Ø±</option>
          <option value="3">3 Ø£Ø´Ù‡Ø±</option>
          <option value="6">6 Ø£Ø´Ù‡Ø±</option>
          <option value="12">12 Ø´Ù‡Ø±</option>
        </select>
      </div>
      <div>
        <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ù‡Ø± (Ø£ÙŠ Ø±Ù‚Ù…)</label>
        <input id="months" type="number" min="1" step="1" placeholder="Ù…Ø«Ø§Ù„: 2 / 5 / 18">
      </div>
      <div>
        <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</label>
        <input id="start" type="date">
      </div>
      <div>
        <label>ØªÙ†Ø¨ÙŠÙ‡ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (Ø£ÙŠØ§Ù…)</label>
        <input id="alertDays" type="number" min="1" step="1" placeholder="Ù…Ø«Ø§Ù„: 7">
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <button class="btn primary" id="saveBtn">ğŸ’¾ Ø­ÙØ¸</button>
      <button class="btn" id="cancelBtn">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<!-- Modal Ù„ØµÙ‚ JSON -->
<div class="modal" id="pasteModal" aria-hidden="true">
  <div class="box">
    <h2>ğŸ“‹ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ø§Ù„Ù„ØµÙ‚ (JSON)</h2>
    <div class="small">Ø§Ù„ØµÙ‚ JSON Ø«Ù… Ø§Ø¶ØºØ· Ø§Ø³ØªÙŠØ±Ø§Ø¯ (ÙŠØªÙ… Ø§Ù„Ø¯Ù…Ø¬ Ø­Ø³Ø¨ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„).</div>
    <label style="margin-top:10px">JSON</label>
    <textarea id="pasteArea" rows="10" style="min-height:200px"></textarea>
    <div class="row" style="margin-top:10px">
      <button class="btn primary" id="doPasteImport">Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
      <button class="btn" id="closePaste">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<script>
const $ = (id)=>document.getElementById(id);

const STORAGE_KEY = "subs_dashboard_data_modal_v1";
const SETTINGS_KEY = "subs_dashboard_settings_modal_v1";

let data = [];
let editingId = null;

/* ===== Utils ===== */
function todayISO(){
  const d=new Date(); d.setHours(0,0,0,0);
  return d.toISOString().slice(0,10);
}
function toDate(iso){
  const d=new Date(iso+"T00:00:00"); d.setHours(0,0,0,0);
  return d;
}
function addMonths(dateISO, m){
  const d=toDate(dateISO);
  const day=d.getDate();
  d.setMonth(d.getMonth()+m);
  if(d.getDate() < day) d.setDate(0);
  return d.toISOString().slice(0,10);
}
function normalizeEmail(e){ return (e||"").trim().toLowerCase(); }
function validateEmail(e){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e); }
function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}
function daysLeft(endISO){
  const now=toDate(todayISO());
  const end=toDate(endISO);
  return Math.round((end-now)/(1000*60*60*24));
}
function getAlertDays(){
  const n = Number($("alertDays").value);
  return (n && n>0) ? n : 7;
}
function status(endISO){
  const left=daysLeft(endISO);
  const alertDays=getAlertDays();
  if(left < 0) return {key:"expired", label:"Ù…Ù†ØªÙ‡ÙŠ", cls:"err", left};
  if(left <= alertDays) return {key:"expiring", label:"Ù‚Ø±ÙŠØ¨ ÙŠÙ†ØªÙ‡ÙŠ", cls:"warn", left};
  return {key:"active", label:"ÙØ¹Ù‘Ø§Ù„", cls:"ok", left};
}

/* ===== Storage ===== */
function load(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    data = raw ? JSON.parse(raw) : [];
    if(!Array.isArray(data)) data=[];
  }catch{ data=[]; }
}
function save(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}
function loadSettings(){
  try{
    const s = JSON.parse(localStorage.getItem(SETTINGS_KEY)||"{}");
    const a = Number(s.alertDays);
    $("alertDays").value = (a && a>0) ? a : 7;
  }catch{
    $("alertDays").value = 7;
  }
}
function saveSettings(){
  localStorage.setItem(SETTINGS_KEY, JSON.stringify({alertDays: getAlertDays()}));
}

/* ===== Modal controls ===== */
function openModal(id){
  const m=$(id);
  m.style.display="flex";
  m.setAttribute("aria-hidden","false");
}
function closeModal(id){
  const m=$(id);
  m.style.display="none";
  m.setAttribute("aria-hidden","true");
}
function resetForm(){
  $("name").value="";
  $("email").value="";
  $("quickPlan").value="";
  $("months").value="";
  $("start").value=todayISO();
  editingId=null;
  $("formTitle").textContent="Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ùƒ";
}

/* Close modals on background click */
["formModal","pasteModal"].forEach(mid=>{
  $(mid).addEventListener("click",(e)=>{
    if(e.target.id===mid) closeModal(mid);
  });
});

/* ===== UI actions ===== */
$("openAdd").onclick = ()=>{
  resetForm();
  loadSettings();               // Ù„Ø¶Ù…Ø§Ù† alertDays ÙŠØ¸Ù‡Ø± ØµØ­ÙŠØ­
  openModal("formModal");
};

$("cancelBtn").onclick = ()=> closeModal("formModal");
$("closePaste").onclick = ()=> closeModal("pasteModal");

$("quickPlan").onchange = ()=>{
  const v = $("quickPlan").value;
  if(v) $("months").value = v;
};

$("search").addEventListener("input", render);

$("clearBtn").onclick = ()=>{
  if(!confirm("Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ")) return;
  data=[]; save(); render();
};

/* ===== Upsert ===== */
function upsert(rec){
  const idxByEmail = data.findIndex(r=>normalizeEmail(r.email)===normalizeEmail(rec.email));

  if(editingId){
    const idxById = data.findIndex(r=>r.id===editingId);
    if(idxById>=0){
      if(idxByEmail>=0 && idxByEmail!==idxById){
        data[idxByEmail] = {...data[idxByEmail], ...rec, id:data[idxByEmail].id};
        data.splice(idxById,1);
      }else{
        data[idxById] = {...data[idxById], ...rec, id:editingId};
      }
      return;
    }
  }

  if(idxByEmail>=0){
    data[idxByEmail] = {...data[idxByEmail], ...rec, id:data[idxByEmail].id};
  }else{
    data.unshift(rec);
  }
}

/* ===== Save record ===== */
$("saveBtn").onclick = ()=>{
  const name = $("name").value.trim();
  const email = normalizeEmail($("email").value);
  const months = Number($("months").value);
  const start = $("start").value;

  if(!name) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…");
  if(!email || !validateEmail(email)) return alert("Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ØºÙŠØ± ØµØ­ÙŠØ­");
  if(!start) return alert("Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©");
  if(!months || months<1) return alert("Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ù‡Ø±");

  // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨
  saveSettings();

  const end = addMonths(start, months);
  const rec = {
    id: editingId || (Date.now()+"_"+Math.random().toString(16).slice(2)),
    name, email, months, start, end
  };

  upsert(rec);
  save();
  render();
  closeModal("formModal");
};

/* ===== Menu â‹¯ per row ===== */
function closeAllMenus(){
  document.querySelectorAll(".menu").forEach(m=>m.style.display="none");
}
document.addEventListener("click",(e)=>{
  if(!e.target.closest(".menuWrap")) closeAllMenus();
});

$("tbody").addEventListener("click",(e)=>{
  const icon = e.target.closest("[data-act='menu']");
  if(icon){
    const wrap = icon.closest(".menuWrap");
    const menu = wrap.querySelector(".menu");
    const isOpen = menu.style.display==="block";
    closeAllMenus();
    menu.style.display = isOpen ? "none" : "block";
    return;
  }

  const btn = e.target.closest("button[data-act]");
  if(!btn) return;

  const act = btn.getAttribute("data-act");
  const id = btn.getAttribute("data-id");
  const rec = data.find(x=>x.id===id);
  if(!rec) return;

  closeAllMenus();

  if(act==="del"){
    if(!confirm("Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ")) return;
    data = data.filter(x=>x.id!==id);
    save(); render(); return;
  }
  if(act==="extend"){
    rec.end = addMonths(rec.end, Number(rec.months));
    save(); render(); return;
  }
  if(act==="edit"){
    editingId = rec.id;
    $("formTitle").textContent="ØªØ¹Ø¯ÙŠÙ„ Ø§Ø´ØªØ±Ø§Ùƒ";
    $("name").value = rec.name||"";
    $("email").value = rec.email||"";
    $("months").value = rec.months||"";
    $("start").value = rec.start||todayISO();
    $("quickPlan").value = ["1","3","6","12"].includes(String(rec.months)) ? String(rec.months) : "";
    loadSettings();
    openModal("formModal");
    return;
  }
});

/* ===== Backup ===== */
function downloadFile(filename, content, mime){
  const blob=new Blob([content],{type:mime});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download=filename;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

$("exportJsonBtn").onclick = ()=>{
  // Ù‚Ø±Ø§Ø¡Ø© alertDays Ù…Ù† storage (Ø£Ùˆ Ø§Ù„Ø­Ø§Ù„ÙŠ)
  const alertDays = Number(localStorage.getItem(SETTINGS_KEY) ? JSON.parse(localStorage.getItem(SETTINGS_KEY)).alertDays : 7) || 7;
  const payload = {version:1, exportedAt:new Date().toISOString(), alertDays, data};
  downloadFile("subscriptions_backup.json", JSON.stringify(payload,null,2), "application/json;charset=utf-8");
};

$("importFileBtn").onclick = ()=> $("fileInput").click();
$("fileInput").addEventListener("change", async ()=>{
  const f=$("fileInput").files[0]; $("fileInput").value="";
  if(!f) return;
  importFromText(await f.text());
});

$("importPasteBtn").onclick = ()=>{
  $("pasteArea").value="";
  openModal("pasteModal");
};
$("doPasteImport").onclick = ()=> importFromText($("pasteArea").value);

function importFromText(text){
  const raw=(text||"").trim();
  if(!raw) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ JSON");

  let incoming;
  try{ incoming = JSON.parse(raw); }
  catch{ alert("JSON ØºÙŠØ± ØµØ§Ù„Ø­"); return; }

  const importedData = Array.isArray(incoming) ? incoming : incoming.data;
  if(!Array.isArray(importedData)){ alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª"); return; }

  if(incoming && typeof incoming.alertDays==="number" && incoming.alertDays>0){
    localStorage.setItem(SETTINGS_KEY, JSON.stringify({alertDays: incoming.alertDays}));
  }

  let added=0, updated=0;
  for(const r of importedData){
    if(!r || !r.email) continue;
    const email = normalizeEmail(r.email);
    if(!email || !validateEmail(email)) continue;

    const months = Number(r.months||1);
    const start = r.start || todayISO();
    const end = r.end || addMonths(start, months);

    const rec = { id: r.id || (Date.now()+"_"+Math.random().toString(16).slice(2)),
      name:(r.name||"").trim(), email, months, start, end };

    const idx = data.findIndex(x=>normalizeEmail(x.email)===email);
    if(idx>=0){ data[idx] = {...data[idx], ...rec, id:data[idx].id}; updated++; }
    else { data.unshift(rec); added++; }
  }

  save(); render();
  closeModal("pasteModal");
  alert(`ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ âœ…\nØ¥Ø¶Ø§ÙØ©: ${added}\nØªØ­Ø¯ÙŠØ«: ${updated}`);
}

$("exportCsvBtn").onclick = ()=>{
  const header=["name","email","months","start","end"];
  const lines=[header.join(",")];
  for(const r of data){
    lines.push([csvCell(r.name),csvCell(r.email),csvCell(r.months),csvCell(r.start),csvCell(r.end)].join(","));
  }
  downloadFile("subscriptions.csv", lines.join("\n"), "text/csv;charset=utf-8");
};
function csvCell(v){
  const s=String(v??"");
  if(/[,"\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
  return s;
}

/* ===== Render ===== */
function render(){
  const q = ($("search").value||"").trim().toLowerCase();
  const tb = $("tbody");
  tb.innerHTML="";

  // alertDays Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† (Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„ÙÙˆØ±Ù… Ù…ØºÙ„Ù‚)
  let alertDays = 7;
  try{
    const s = JSON.parse(localStorage.getItem(SETTINGS_KEY)||"{}");
    const a = Number(s.alertDays);
    if(a && a>0) alertDays=a;
  }catch{}
  // Ù†Ø­ØªØ§Ø¬ alertDays Ù„Ù„Ø­Ø³Ø§Ø¨ Ø¯Ø§Ø®Ù„ status -> Ù…Ø¤Ù‚ØªÙ‹Ø§ Ù†Ø¶Ø¨Ø· input Ù„Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯
  // (Ø§Ù„Ù€ input Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ØŒ Ù„ÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø¦Ù…Ù‹Ø§ ÙÙŠ DOM)
  $("alertDays").value = alertDays;

  const allCounts={active:0, expiring:0, expired:0};
  for(const r of data){
    allCounts[status(r.end).key]++;
  }

  const rows = data.filter(r=>{
    if(!q) return true;
    return (r.name||"").toLowerCase().includes(q) || normalizeEmail(r.email).includes(q);
  });

  for(const r of rows){
    const st = status(r.end);
    const tr = document.createElement("tr");
    if(st.key==="expired") tr.classList.add("expired-row");
    if(st.key==="expiring") tr.classList.add("expiring-row");

    const leftTxt = st.left < 0 ? `Ø§Ù†ØªÙ‡Ù‰ Ù…Ù†Ø° ${Math.abs(st.left)} ÙŠÙˆÙ…` : `${st.left} ÙŠÙˆÙ…`;

    tr.innerHTML = `
      <td>${escapeHtml(r.name)}</td>
      <td>${escapeHtml(r.email)}</td>
      <td>${r.months} Ø´Ù‡Ø±</td>
      <td>${r.start}</td>
      <td>${r.end}</td>
      <td>${leftTxt}</td>
      <td><span class="badge ${st.cls}">${st.label}</span></td>
      <td>
        <span class="menuWrap">
          <button class="iconBtn" data-act="menu" title="Ø®ÙŠØ§Ø±Ø§Øª">â‹¯</button>
          <div class="menu">
            <button data-act="edit" data-id="${r.id}">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
            <button data-act="extend" data-id="${r.id}">â• ØªÙ…Ø¯ÙŠØ¯ Ù†ÙØ³ Ø§Ù„Ù…Ø¯Ø©</button>
            <button class="danger" data-act="del" data-id="${r.id}">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          </div>
        </span>
      </td>
    `;
    tb.appendChild(tr);
  }

  $("stats").textContent =
    `Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶: ${rows.length} | Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${data.length} | ÙØ¹Ù‘Ø§Ù„: ${allCounts.active} | Ù‚Ø±ÙŠØ¨: ${allCounts.expiring} | Ù…Ù†ØªÙ‡ÙŠ: ${allCounts.expired}`;
}

/* init */
load();
loadSettings();
$("start").value = todayISO();
render();
</script>
</body>
</html>
