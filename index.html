<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<title>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root{--bg:#07101f;--card:rgba(255,255,255,.06);--card2:rgba(255,255,255,.04);--line:rgba(255,255,255,.10);--text:#eaf0ff;--muted:#9fb0d0;--accent:#4da3ff;--good:#2fe39a;--bad:#ff6b6b;--warn:#ffcf5a;--shadow:0 14px 40px rgba(0,0,0,.35);--radius:18px}
*{box-sizing:border-box}
body{margin:0;padding:14px;font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial;color:var(--text);background:radial-gradient(900px 600px at 15% 0%, rgba(77,163,255,.18), transparent 60%),radial-gradient(700px 500px at 90% 15%, rgba(47,227,154,.12), transparent 55%),var(--bg);overflow-x:hidden}
.container{max-width:1120px;margin:0 auto;overflow-x:hidden}
.header{display:flex;justify-content:space-between;align-items:flex-end;gap:12px;flex-wrap:wrap;margin:6px 0 14px}
h1{margin:0;font-size:20px}
.sub{margin:6px 0 0;color:var(--muted);font-size:13px}
.card{background:linear-gradient(180deg,var(--card),var(--card2));border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin-bottom:14px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.right{margin-right:auto}
.input,.select,.textarea{width:100%;padding:12px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.20);color:var(--text);outline:none;font-size:14px}
.textarea{min-height:90px;resize:vertical}
.input::placeholder,.textarea::placeholder{color:rgba(234,240,255,.55)}
.input:focus,.select:focus,.textarea:focus{border-color:rgba(77,163,255,.55);box-shadow:0 0 0 3px rgba(77,163,255,.18)}
.btn{padding:12px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.07);color:var(--text);cursor:pointer;font-size:14px;transition:.15s;display:inline-flex;gap:8px;align-items:center;user-select:none}
.btn:hover{background:rgba(255,255,255,.10)}
.btn:active{transform:translateY(1px)}
.btn.primary{border-color:rgba(77,163,255,.45);background:rgba(77,163,255,.16)}
.btn.danger{border-color:rgba(255,107,107,.45);background:rgba(255,107,107,.14)}
.btn.ghost{background:transparent}
.badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);white-space:nowrap}
.dot{width:7px;height:7px;border-radius:50%}
.ok .dot{background:var(--good)}.bad .dot{background:var(--bad)}.warn .dot{background:var(--warn)}
.modalGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.full{grid-column:1 / -1}
.tableWrap{max-width:100%;overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch;touch-action:pan-x;border-radius:14px;border:1px solid rgba(255,255,255,.10)}
table{width:100%;min-width:1100px;border-collapse:separate;border-spacing:0}
th,td{padding:12px 10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:right;font-size:13px;vertical-align:top}
th{position:sticky;top:0;background:rgba(10,18,35,.85);backdrop-filter:blur(8px);color:var(--muted);z-index:1}
tr:hover td{background:rgba(255,255,255,.03)}
.muted{color:var(--muted);font-size:12px}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:12px}
.kpi{padding:12px;border-radius:16px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18)}
.kpi .t{color:var(--muted);font-size:12px}
.kpi .v{font-size:18px;margin-top:6px}
.modalBack{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:14px;z-index:999}
.modal{width:min(760px,100%);background:linear-gradient(180deg,rgba(18,28,51,.98),rgba(18,28,51,.90));border:1px solid rgba(255,255,255,.12);border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.45);padding:14px}
.modalHeader{display:flex;align-items:center;gap:10px;justify-content:space-between;margin-bottom:10px}
.modalHeader h3{margin:0;font-size:16px}
hr{border:0;border-top:1px solid rgba(255,255,255,.10);margin:10px 0}
.actions{position:relative;display:inline-block}
.menu{position:absolute;inset-inline-end:0;min-width:210px;background:rgba(18,28,51,.98);border:1px solid rgba(255,255,255,.12);border-radius:14px;box-shadow:0 18px 60px rgba(0,0,0,.45);padding:6px;display:none;z-index:50}
.menu.down{top:44px}.menu.up{bottom:44px}.menu.open{display:block}
.menu button{width:100%;justify-content:flex-start;padding:10px 12px;border-radius:12px;border:0;background:transparent;color:var(--text);cursor:pointer;display:flex;gap:10px;align-items:center;font-size:14px;text-align:right}
.menu button:hover{background:rgba(255,255,255,.08)}
.menu .dangerItem{color:#ffd0d0}
.menu .sep{height:1px;background:rgba(255,255,255,.10);margin:6px 4px}
@media (max-width:860px){.kpis{grid-template-columns:repeat(2,1fr)}.grid3{grid-template-columns:1fr}}
@media (max-width:720px){body{padding:10px}.grid2{grid-template-columns:1fr}}

.toggleWrap{display:inline-flex;align-items:center;gap:10px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);font-size:12px;color:var(--muted)}
.switch{position:relative;width:44px;height:24px;display:inline-block}
.switch input{opacity:0;width:0;height:0}
.slider{position:absolute;cursor:pointer;inset:0;border-radius:999px;border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.22);transition:.15s}
.slider:before{content:"";position:absolute;height:18px;width:18px;right:3px;top:2px;border-radius:50%;background:rgba(255,255,255,.75);transition:.15s}
.switch input:checked + .slider{background:rgba(47,227,154,.16);border-color:rgba(47,227,154,.35)}
.switch input:checked + .slider:before{transform:translateX(-20px);background:rgba(255,255,255,.9)}

#syncMenuBtn{display:none}

/* --- Chart collapse (show only when Monthly Income opened) --- */
#chartWrap{display:none !important;margin-top:10px}
#incomeChart{max-height:240px;width:100% !important}


/* --- Chart stability fix --- */
#chartWrap{min-height:260px}
#incomeChart{height:240px !important; max-height:240px}


/* --- Chart toggle switch --- */
#chartWrap{display:none !important; min-height:260px; margin-top:8px}
#incomeChart{height:240px !important; max-height:240px; width:100% !important}
.switch{position:relative;display:inline-block;width:46px;height:24px;flex:0 0 auto}
.switch input{opacity:0;width:0;height:0}
.slider{position:absolute;cursor:pointer;inset:0;background:rgba(255,255,255,.25);border-radius:24px;transition:.25s}
.slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background:white;border-radius:50%;transition:.25s}
.switch input:checked + .slider{background:rgba(76,175,80,.9)}
.switch input:checked + .slider:before{transform:translateX(22px)}


/* --- Actions menu (details-based, mobile reliable) --- */
.actionsDetails{position:relative;display:inline-block}
.actionsDetails summary{cursor:pointer;list-style:none}
.actionsDetails summary::-webkit-details-marker{display:none}
.menuDetails{
  position:absolute;
  inset-inline-end:0;
  min-width:210px;
  background:rgba(18,28,51,.98);
  border:1px solid rgba(255,255,255,.12);
  border-radius:14px;
  box-shadow:0 18px 60px rgba(0,0,0,.45);
  padding:6px;
  z-index:80;
  display:none;
}
.actionsDetails[open] .menuDetails{display:block}
.menuDetails button{
  width:100%;
  text-align:start;
  padding:10px 10px;
  background:transparent;
  border:0;
  color:#e8eefc;
  border-radius:10px;
  cursor:pointer;
}
.menuDetails button:hover{background:rgba(255,255,255,.08)}
.menuDetails .sep{height:1px;background:rgba(255,255,255,.10);margin:6px 0}


/* --- Fix: actions menu not fully visible inside scrollers --- */
.tableWrap{overflow-x:auto; overflow-y:visible !important; padding-bottom:180px;}
.actionsDetails{z-index:200;}
.menuDetails{
  max-height:260px;
  overflow:auto;
}


table, thead, tbody, tr, td, th{overflow:visible}


/* --- Center actions modal to avoid clipping --- */
#actionsModalBack{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:9999;padding:16px}
#actionsModalBack .modal{width:min(420px, 96vw);max-height:85vh;overflow:auto}
.modalGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.btn.danger{background:rgba(244,67,54,.95)}


/* --- Renew options UI in actions modal --- */
.renewBox{margin-top:12px;padding:10px;border:1px solid rgba(255,255,255,.10);border-radius:14px;background:rgba(255,255,255,.03)}
.renewTitle{font-weight:700;margin-bottom:10px}
.renewChips{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
.chip{
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  color:#e8eefc;
  padding:8px 12px;
  border-radius:999px;
  cursor:pointer;
  touch-action:manipulation;
}
.chip.active{background:rgba(59,130,246,.25);border-color:rgba(59,130,246,.55)}
.renewManual{margin-top:8px}
.renewLabel{display:block;opacity:.85;margin-bottom:6px}
.renewRow{display:flex;gap:10px;align-items:center}
.renewInput{
  flex:1;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.15);
  color:#e8eefc;
  outline:none;
}
.renewHint{opacity:.7;margin-top:8px;font-size:.9em}


#app{display:none}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>
      <h1>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</h1>
      <p class="sub">Ù…Ù„Ù ÙˆØ§Ø­Ø¯ â€” Ø¥Ø¹Ø¯Ø§Ø¯ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø© + ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ù„ÙˆØ­Ø© + Backup/Restore</p>
    </div>
    <div class="row">
      <span class="badge" id="roleTag" style="display:none"><span class="dot"></span> Ø§Ù„Ø¯ÙˆØ±: -</span>
      <button class="btn" id="lockBtn" style="display:none" onclick="lockNow()">ğŸ”’ Ù‚ÙÙ„</button>
      <button class="btn" id="logoutBtn" style="display:none" onclick="logout()">ğŸšª Ø®Ø±ÙˆØ¬</button>
    <button class="btn primary" id="syncMenuBtn" onclick="openSyncMenu()">â˜ï¸ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</button>
</div>
  </div>

  <div class="card" id="loginCard" style="display:none">
    <div class="row">
      <input class="input" id="user" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (admin / staff / viewer)" autocomplete="username">
      <input class="input" id="pass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" autocomplete="current-password">
      <button class="btn primary" onclick="login()">ğŸ” Ø¯Ø®ÙˆÙ„</button>
    </div>
    <p class="muted" style="margin:10px 0 0" id="lockMsg"></p>

    <hr>
    <div class="row" style="justify-content:space-between">
      <div>
        <div style="font-size:14px">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯ Ø£ÙˆÙ„ Ù…Ø±Ø© (Ø¨Ø¯ÙˆÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù)</div>
        <div class="muted">Ø³ÙŠØªÙ… Ø­ÙØ¸ Hash Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØµÙØ­</div>
      </div>
      <button class="btn" onclick="toggleSetup()">ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <div id="setupBox" style="display:none; margin-top:10px">
      <div class="grid3">
        <input class="input" id="s_admin" type="password" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± admin (Ù…Ø·Ù„ÙˆØ¨Ø©)">
        <input class="input" id="s_staff" type="password" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± staff (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
        <input class="input" id="s_viewer" type="password" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± viewer (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn primary" onclick="saveSetup()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯</button>
        <button class="btn danger" onclick="resetSetup()">ğŸ§¹ Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯</button>
        <span class="muted">Ø¥Ø°Ø§ ØªØ±ÙƒØª staff/viewer ÙØ§Ø±ØºÙŠÙ† â†’ Ù†ÙØ³ ÙƒÙ„Ù…Ø© admin</span>
      </div>
      <p class="muted" style="margin-top:8px">Ù†ØµÙŠØ­Ø©: Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ØŒ Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ admin Ø«Ù… Ø§Ø¹Ù…Ù„ Backup.</p>
    </div>

    <hr>
    <p class="muted">
      âš ï¸ Ø¹Ù„Ù‰ Ø¨Ø¹Ø¶ Ø£Ø¬Ù‡Ø²Ø© Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ Ù‚Ø¯ Ù„Ø§ ÙŠÙƒÙˆÙ† Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø«Ø§Ø¨ØªÙ‹Ø§ Ù…Ø¹ <b>file://</b>.
      Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± <b>Backup</b> Ø¯Ø§Ø®Ù„ Ø§Ù„Ù„ÙˆØ­Ø© Ù„ØªÙØ§Ø¯ÙŠ Ø¶ÙŠØ§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.
    </p>
  </div>

  <div id="app" style="display:none">
    <div class="card">
      <div class="kpis">
        <div class="kpi"><div class="t">Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div><div class="v" id="k_all">0</div></div>
        <div class="kpi"><div class="t">Ù†Ø´Ø·</div><div class="v" id="k_active">0</div></div>
        <div class="kpi"><div class="t">Ù‚Ø§Ø±Ø¨ ÙŠÙ†ØªÙ‡ÙŠ (â‰¤ 7 Ø£ÙŠØ§Ù…)</div><div class="v" id="k_near">0</div></div>
        <div class="kpi"><div class="t">Ù…Ù†ØªÙ‡ÙŠ</div><div class="v" id="k_expired">0</div></div>
      </div>

      <div class="grid3">
        <input class="input" id="search" placeholder="ğŸ” Ø¨Ø­Ø« (Ø¨Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„/Ø§Ù„Ø®Ø·Ø©/Ù…Ù„Ø§Ø­Ø¸Ø§Øª)..." oninput="render()">
        <select class="select" id="filterStatus" onchange="render()">
          <option value="all">ÙÙ„ØªØ±Ø©: Ø§Ù„ÙƒÙ„</option>
          <option value="active">Ù†Ø´Ø·</option>
          <option value="near">Ù‚Ø§Ø±Ø¨ ÙŠÙ†ØªÙ‡ÙŠ</option>
          <option value="expired">Ù…Ù†ØªÙ‡ÙŠ</option>
        </select>
        <select class="select" id="sort" onchange="render()">
          <option value="newest">ØªØ±ØªÙŠØ¨: Ø§Ù„Ø£Ø­Ø¯Ø« Ø¥Ø¶Ø§ÙØ©</option>
          <option value="oldest">Ø§Ù„Ø£Ù‚Ø¯Ù… Ø¥Ø¶Ø§ÙØ©</option>
          <option value="end_asc">Ø§Ù„Ø£Ù‚Ø±Ø¨ Ø§Ù†ØªÙ‡Ø§Ø¡Ù‹</option>
          <option value="end_desc">Ø§Ù„Ø£Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡Ù‹</option>
          <option value="name_asc">Ø§Ù„Ø§Ø³Ù… (Ø£-ÙŠ)</option>
          <option value="name_desc">Ø§Ù„Ø§Ø³Ù… (ÙŠ-Ø£)</option>
          <option value="email_asc">Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ (A-Z)</option>
          <option value="email_desc">Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ (Z-A)</option>
        </select>
      </div>

      <hr>

      <div class="row">
        <button class="btn primary" id="addBtn" onclick="openAdd()">â• Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ùƒ</button>
        <button class="btn" id="exportBtn" onclick="exportCSV()">â¬‡ï¸ ØªØµØ¯ÙŠØ± CSV</button>

        <label class="btn" id="importBtn" style="cursor:pointer">
          â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ CSV
          <input type="file" accept="text/csv,application/vnd.ms-excel,application/csv,.csv" style="display:none" onchange="importCSV(event)">
        </label>

        
        
        
        
        
        <span class="toggleWrap" title="ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ø°Ø§ Ù…Ø±Ù‘ ÙŠÙˆÙ… Ø¨Ø¯ÙˆÙ† Backup/Restore">
          <span>ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù†Ø³Ø® Ø§Ù„ÙŠÙˆÙ…ÙŠ</span>
          <label class="switch">
            <input type="checkbox" id="autoBackupToggle">
            <span class="slider"></span>
          </label>
        </span>

        <span class="badge" id="syncBadge" title="Ø¢Ø®Ø± Backup/Restore" style="margin-inline-start:6px"><span class="dot"></span><span id="syncText">Ø¢Ø®Ø± Ù…Ø²Ø§Ù…Ù†Ø©: -</span></span>

        <label class="btn" style="cursor:pointer">
          ğŸ“¥ Restore
          <input type="file" accept=".json" style="display:none" onchange="restoreJSON(event)">
        </label>

        <button class="btn" onclick="openPwModal()">ğŸ”‘ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>

        <select class="select" id="renewMode" style="max-width:260px" title="Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ¬Ø¯ÙŠØ¯">
          <option value="end" selected>Ø§Ù„ØªØ¬Ø¯ÙŠØ¯: Ù…Ù† ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</option>
          <option value="today">Ø§Ù„ØªØ¬Ø¯ÙŠØ¯: Ù…Ù† Ø§Ù„ÙŠÙˆÙ…</option>
        </select>

        <span class="right"></span>
        <button class="btn danger" id="clearBtn" onclick="clearAll()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
      </div>
      <p class="muted" style="margin:10px 0 0">ØµÙŠØºØ© CSV: name,email,plan,price,start,months,notes</p>
      <p class="muted" style="margin:6px 0 0">ğŸ’¡ Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨ÙŠÙ† Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø¨Ø¯ÙˆÙ† Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª: Ø§Ø¶ØºØ· <b>Ù…Ø´Ø§Ø±ÙƒØ© Backup</b> ÙˆØ§Ø®ØªØ± Google Drive/Dropbox/TelegramØŒ Ø«Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø¢Ø®Ø± Ø§Ø¶ØºØ· <b>Restore</b> ÙˆØ§Ø®ØªØ± Ù†ÙØ³ Ø§Ù„Ù…Ù„Ù.</p>
    </div>

    <div class="card" id="incomeCard">
      <div class="row" style="justify-content:space-between; align-items:center">
        <div>
          <div style="font-size:16px; margin-bottom:6px">ğŸ’° Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø´Ù‡Ø±ÙŠ</div>
          <div class="muted">Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø± ÙˆØ·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø­Ø³Ø§Ø¨</div>
        </div>
        <div class="badge"><span class="dot"></span><span id="incomeRoleNote">ØªÙ‚Ø§Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠØ©</span></div>
      </div>

      <div class="grid3" style="margin-top:10px">
        <input class="input" id="incomeMonth" type="month">
        <select class="select" id="incomeMode" onchange="calcMonthlyIncome()">
          <option value="start" selected>Ø­Ø³Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Ø¨Ø¯Ø£Øª Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±)</option>
          <option value="spread">Ù…ÙˆØ²Ù‘Ø¹ Ø¹Ù„Ù‰ Ø£Ø´Ù‡Ø± Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ (Ø§Ù„Ø³Ø¹Ø±/Ø§Ù„Ù…Ø¯Ø©)</option>
          <option value="payments">Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙØ¹Ø§Øª/Ø§Ù„ØªØ¬Ø¯ÙŠØ¯Ø§Øª (Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª)</option>
        </select>
        <select class="select" id="currency" onchange="calcMonthlyIncome()">
          <option value="DZD" selected>DZD</option>
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
          <option value="custom">Ø¹Ù…Ù„Ø© Ù…Ø®ØµØµØ©...</option>
        </select>
      </div>

      <div class="row" style="margin-top:10px">
        <input class="input" id="customCurrency" placeholder="Ø§ÙƒØªØ¨ Ø±Ù…Ø² Ø§Ù„Ø¹Ù…Ù„Ø© (Ù…Ø«Ø§Ù„: MAD)" style="display:none; max-width:260px">
        <button class="btn primary" onclick="calcMonthlyIncome()">ğŸ§® Ø§Ø­Ø³Ø¨</button>
      </div>

      <div class="kpis" style="margin-top:12px">
        <div class="kpi">
          <div class="t">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø®Ù„ Ù„Ù„Ø´Ù‡Ø±</div>
          <div class="v" id="incomeTotal">0</div>
          <div class="muted" id="incomeHint" style="margin-top:6px"></div>
        </div>
        <div class="kpi"><div class="t">Ø¹Ø¯Ø¯</div><div class="v" id="incomeCount">0</div></div>
        <div class="kpi"><div class="t">Ù…ØªÙˆØ³Ø·</div><div class="v" id="incomeAvg">0</div></div>
        <div class="kpi"><div class="t">Ø£Ø¹Ù„Ù‰ Ø®Ø·Ø©</div><div class="v" id="incomeTopPlan">-</div></div>
      </div>

      <div class="tableWrap" style="margin-top:12px">
        <table style="min-width:700px">
          <thead><tr><th>Ø§Ù„Ø®Ø·Ø©</th><th>Ø¹Ø¯Ø¯</th><th>Ø§Ù„Ø¯Ø®Ù„</th></tr></thead>
          <tbody id="incomePlanRows"></tbody>
        </table>
      </div>

      <div class="card" style="margin-top:12px; padding:12px">
        <div class="row" style="justify-content:space-between">
          <div style="font-size:14px">ğŸ“ˆ Ø§Ù„Ø¯Ø®Ù„ Ø¢Ø®Ø± 6 Ø£Ø´Ù‡Ø±</div>
          <div class="muted" id="chartHint"></div>
        </div>
        
<div class="row" style="margin:10px 0; align-items:center; gap:10px">
  <label class="switch">
    <input type="checkbox" id="chartToggle" onchange="toggleChartSwitch(this.checked)">
    <span class="slider"></span>
  </label>
  <span class="muted">Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø®Ø· Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ</span>
</div>

<div id="chartWrap" style="display:none"><canvas id="incomeChart" height="90" style="width:100%; margin-top:10px"></canvas></div>
      </div>
    </div>

    <div class="card">
      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</th><th>Ø§Ù„Ø®Ø·Ø©</th><th>Ø§Ù„Ø³Ø¹Ø±</th>
              <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th><th>Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
      <p class="muted" id="stats" style="margin:10px 0 0"></p>
    </div>
  </div>
</div>

<div class="modalBack" id="modalBack" onclick="closeModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modalHeader">
      <h3 id="modalTitle">Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„</h3>
      <button class="btn ghost" onclick="closeModal()">âœ–</button>
    </div>

    <div class="modalGrid">
      <input class="input" id="m_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
      <input class="input" id="m_email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
      <input class="input" id="m_plan" placeholder="Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø©">
      <input class="input" id="m_price" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±">
      <input class="input" id="m_start" type="date">
      <input class="input" id="m_months" type="number" min="1" placeholder="Ø§Ù„Ù…Ø¯Ø© Ø¨Ø§Ù„Ø£Ø´Ù‡Ø±">
      <textarea class="textarea full" id="m_notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª"></textarea>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn primary" id="saveBtn" onclick="saveModal()">ğŸ’¾ Ø­ÙØ¸</button>
      <button class="btn" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
      <span class="right"></span>
      <button class="btn danger" id="deleteBtn" onclick="deleteFromModal()" style="display:none">ğŸ—‘ï¸ Ø­Ø°Ù</button>
    </div>

    <p class="muted" style="margin:10px 0 0" id="preview"></p>
  </div>
</div>

<div class="modalBack" id="pwBack" onclick="closePwModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modalHeader">
      <h3>ğŸ”‘ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
      <button class="btn ghost" onclick="closePwModal()">âœ–</button>
    </div>

    <div class="modalGrid">
      <input class="input" id="pw_current" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©">
      <select class="select" id="pw_target">
        <option value="self">ØªØºÙŠÙŠØ± Ù„Ø­Ø³Ø§Ø¨ÙŠ ÙÙ‚Ø·</option>
        <option value="all">ØªØºÙŠÙŠØ± Ù„ÙƒÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª (admin/staff/viewer)</option>
      </select>

      <input class="input" id="pw_new" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
      <input class="input" id="pw_new2" type="password" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
    </div>

    <p class="muted" style="margin:10px 0 0">
      Ø¥Ø°Ø§ Ø§Ø®ØªØ±Øª â€œÙ„ÙƒÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øªâ€ØŒ Ø³ÙŠØªÙ… ÙˆØ¶Ø¹ Ù†ÙØ³ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ø¬Ù…ÙŠØ¹.
    </p>

    <div class="row" style="margin-top:12px">
      <button class="btn primary" onclick="saveNewPassword()">ğŸ’¾ Ø­ÙØ¸</button>
      <button class="btn" onclick="closePwModal()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>


<div class="modalBack" id="syncHelpBack" onclick="closeSyncHelp(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modalHeader">
      <h3>â“ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© (Google Drive / Dropbox / Telegram)</h3>
      <button class="btn ghost" onclick="closeSyncHelp()">âœ–</button>
    </div>

    <div class="card" style="margin:0; padding:12px">
      <div class="muted" style="line-height:1.9">
        <b>Ø§Ù„ÙÙƒØ±Ø©:</b> Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ø¯ÙˆÙ† Ø³ÙŠØ±ÙØ±. Ù„ÙƒÙ† ØªÙ‚Ø¯Ø± ØªØ¹Ù…Ù„Ù‡Ø§ Ø¨Ø³Ù‡ÙˆÙ„Ø© Ø¹Ø¨Ø± Ù…Ù„Ù ÙˆØ§Ø­Ø¯ Ø§Ø³Ù…Ù‡ <b>backup.json</b>.
        <br>âœ… Ø¨Ø¹Ø¯ Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²: <b>ğŸ’¾ Backup</b> Ø£Ùˆ <b>ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ© Backup</b>
        <br>âœ… Ù‚Ø¨Ù„ Ø§Ø³ØªØ¹Ù…Ø§Ù„ Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±: <b>ğŸ“¥ Restore</b> ÙˆØ§Ø®ØªØ± Ù†ÙØ³ Ø§Ù„Ù…Ù„Ù
      </div>
      <hr>

      <div class="modalGrid">
        <div class="card" style="margin:0; padding:12px">
          <div style="font-size:14px; margin-bottom:6px">â˜ï¸ Google Drive</div>
          <div class="muted" style="line-height:1.9">
            1) Ø§Ø¶ØºØ· <b>ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ© Backup</b> ÙˆØ§Ø®ØªØ± <b>Drive</b> ÙˆØ§Ø­ÙØ¸Ù‡ Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù„Ø¯ Ø«Ø§Ø¨Øª (Ù…Ø«Ø§Ù„: Subscriptions-App).<br>
            2) Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø­Ù…Ù‘Ù„ <b>backup.json</b> Ù…Ù† Drive Ø«Ù… Ø§Ø¶ØºØ· <b>ğŸ“¥ Restore</b>.
          </div>
        </div>

        <div class="card" style="margin:0; padding:12px">
          <div style="font-size:14px; margin-bottom:6px">â˜ï¸ Dropbox</div>
          <div class="muted" style="line-height:1.9">
            1) Ø§Ø¶ØºØ· <b>ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ© Backup</b> ÙˆØ§Ø®ØªØ± <b>Dropbox</b> ÙˆØ§Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù….<br>
            2) Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø­Ù…Ù‘Ù„ <b>backup.json</b> Ù…Ù† Dropbox Ø«Ù… <b>ğŸ“¥ Restore</b>.
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:10px; padding:12px">
        <div style="font-size:14px; margin-bottom:6px">âœˆï¸ Telegram (Saved Messages)</div>
        <div class="muted" style="line-height:1.9">
          1) Ø¨Ø¹Ø¯ BackupØŒ Ø£Ø±Ø³Ù„ <b>backup.json</b> Ø¥Ù„Ù‰ <b>Saved Messages</b>.<br>
          2) Ø¹Ù„Ù‰ Ø£ÙŠ Ø¬Ù‡Ø§Ø²: Ø­Ù…Ù‘Ù„ Ø¢Ø®Ø± Ù…Ù„Ù Ø«Ù… Ø§Ø¹Ù…Ù„ <b>Restore</b>.
        </div>
      </div>

      <div class="card" style="margin-top:10px; padding:12px">
        <div style="font-size:14px; margin-bottom:6px">âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù‡Ù…Ø©</div>
        <div class="muted" style="line-height:1.9">
          ØªØ¬Ù†Ù‘Ø¨ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²ÙŠÙ† ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª Ø¨Ø¯ÙˆÙ† Backup Ø¨ÙŠÙ†Ù‡Ù…Ø§ØŒ Ù„Ø£Ù† Ø¢Ø®Ø± Ù…Ù„Ù Ø³ÙŠØºÙ„Ø¨.
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      
      <button class="btn" onclick="closeSyncHelp()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>


<script>
window.__USE_FIREBASE_AUTH = true;
</script>
<script>
const KEY="subs_data_allinone_v1";
const LOG_KEY="subs_log_allinone_v1";
const CONFIG_KEY="subs_users_config_allinone_v1";
const AUTO_BACKUP_KEY="subs_auto_backup_reminder_v1";

const LAST_SYNC_KEY="subs_last_sync_allinone_v1";

async function sha256Base64(text){
  const enc=new TextEncoder().encode(text);
  const buf=await crypto.subtle.digest("SHA-256",enc);
  const bytes=new Uint8Array(buf);
  let bin="";bytes.forEach(b=>bin+=String.fromCharCode(b));
  return btoa(bin);
}

const DEFAULT_USERS=[
  {username:"admin",role:"admin",passHash:""},
  {username:"staff",role:"staff",passHash:""},
  {username:"viewer",role:"viewer",passHash:""}
];
function loadUsers(){
  try{
    const cfg=JSON.parse(localStorage.getItem(CONFIG_KEY)||"null");
    if(cfg&&Array.isArray(cfg)&&cfg.every(x=>x.username&&x.passHash&&x.role)) return cfg;
  }catch{}
  return DEFAULT_USERS;
}
function saveUsers(cfg){localStorage.setItem(CONFIG_KEY,JSON.stringify(cfg));}
function toggleSetup(){
  const box=document.getElementById("setupBox");
  box.style.display=(box.style.display==="none"?"block":"none");
}
async function saveSetup(){
  const adminP=(document.getElementById("s_admin").value||"").trim();
  const staffP=(document.getElementById("s_staff").value||"").trim()||adminP;
  const viewerP=(document.getElementById("s_viewer").value||"").trim()||adminP;
  if(!adminP){alert("Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± admin Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");return;}
  const cfg=[
    {username:"admin",role:"admin",passHash:await sha256Base64(adminP)},
    {username:"staff",role:"staff",passHash:await sha256Base64(staffP)},
    {username:"viewer",role:"viewer",passHash:await sha256Base64(viewerP)}
  ];
  saveUsers(cfg);
  alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ âœ… Ø§Ù„Ø¢Ù† Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ");
}
function resetSetup(){localStorage.removeItem(CONFIG_KEY);alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ù† Ø¬Ø¯ÙŠØ¯.");}

function getRole(){return sessionStorage.getItem("role")||null;}
function setRole(role){sessionStorage.setItem("role",role);}
function logout(){
  setSyncBtnVisible(false);sessionStorage.removeItem("role");location.reload();}
function lockNow(){logout();}
function canEdit(){const r=getRole();return r==="admin"||r==="staff";}
function canDelete(){return getRole()==="admin";}
function canImportClear(){return getRole()==="admin";}

let failCount=0,lockUntil=0;
let autoLogoutTimer=null;
function scheduleAutoLogout(){
  if(autoLogoutTimer) clearTimeout(autoLogoutTimer);
  autoLogoutTimer=setTimeout(()=>logout(),15*60*1000);
}

async function login(){
  if(Date.now()<lockUntil){
    const sec=Math.ceil((lockUntil-Date.now())/1000);
    lockMsg.textContent=`ØªÙ… Ù‚ÙÙ„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¤Ù‚ØªØ§Ù‹. Ø­Ø§ÙˆÙ„ Ø¨Ø¹Ø¯ ${sec} Ø«Ø§Ù†ÙŠØ©.`;
    return;
  } else lockMsg.textContent="";

  const u=(user.value||"").trim();
  const p=(pass.value||"").trim();
  const USERS=loadUsers();
  const found=USERS.find(x=>x.username===u);

  if(!found||!found.passHash){
    lockMsg.textContent="Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø¹Ø¯Ø§Ø¯ ÙƒÙ„Ù…Ø§Øª Ù…Ø±ÙˆØ±. Ø§ÙØªØ­ (Ø¥Ø¹Ø¯Ø§Ø¯ Ø£ÙˆÙ„ Ù…Ø±Ø©) ÙˆØ§Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯.";
    return;
  }
  const h=await sha256Base64(p);
  if(h!==found.passHash){onBadLogin();return;}

  failCount=0;lockUntil=0;lockMsg.textContent="";
  setRole(found.role);
  bootAuthed();
}
function onBadLogin(){
  failCount++;
  if(failCount>=5){
    lockUntil=Date.now()+30000;
    failCount=0;
    lockMsg.textContent="Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙƒØ«ÙŠØ±Ø©. ØªÙ… Ù‚ÙÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ 30 Ø«Ø§Ù†ÙŠØ©.";
  } else lockMsg.textContent="Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
}

function applyRoleUI(){
  const role=getRole()||"viewer";
  roleTag.innerHTML=`<span class="dot"></span> Ø§Ù„Ø¯ÙˆØ±: ${role}`;
  roleTag.classList.remove("ok","warn","bad");
  if(role==="admin") roleTag.classList.add("ok");
  else if(role==="staff") roleTag.classList.add("warn");
  else roleTag.classList.add("bad");

  addBtn.style.display=canEdit()?"inline-flex":"none";
  saveBtn.style.display=canEdit()?"inline-flex":"none";
  importBtn.style.display=canImportClear()?"inline-flex":"none";
  clearBtn.style.display=canImportClear()?"inline-flex":"none";
  exportBtn.style.display="inline-flex";
}
function bootAuthed(){
  loginCard.style.display="none";
  app.style.display="block";
  roleTag.style.display="inline-flex";
  logoutBtn.style.display="inline-flex";
  lockBtn.style.display="inline-flex";
  applyRoleUI();
  setSyncBtnVisible(true);
  updateSyncBadge();
  render();
  ensureIncomeDefaults();
  calcMonthlyIncome();
  maybeRemindBackup();
  scheduleAutoLogout();
  ["click","keydown","mousemove","touchstart"].forEach(ev=>{
    window.addEventListener(ev,scheduleAutoLogout,{passive:true});
  });
}

function load(){try{return JSON.parse(localStorage.getItem(KEY)||"[]");}catch{return[];}}
function save(d){localStorage.setItem(KEY,JSON.stringify(d));}
function loadLog(){try{return JSON.parse(localStorage.getItem(LOG_KEY)||"[]");}catch{return[];}}
function saveLog(list){localStorage.setItem(LOG_KEY,JSON.stringify(list));}
function addLog(action,payload){
  const role=getRole()||"unknown";
  const item={t:Date.now(),role,action,...payload};
  const log=loadLog();
  log.push(item);
  if(log.length>5000) log.splice(0,log.length-5000);
  saveLog(log);
}

function backupJSON(){
  const payload={exportedAt:new Date().toISOString(),data:load(),log:loadLog()};
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json;charset=utf-8"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;a.download="backup.json";
  document.body.appendChild(a);a.click();a.remove();
  URL.revokeObjectURL(url);
  localStorage.setItem(LAST_SYNC_KEY, JSON.stringify({type:"backup", t:Date.now()}));
  updateSyncBadge();
  alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© (backup.json)");
}
function restoreJSON(event){
  const file = event.target.files && event.target.files[0];
  if(!file) return;

  const handleText = (txt)=>{
    let obj;
    try{ obj = JSON.parse(txt); }catch{ alert("Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­"); event.target.value=""; return; }
    if(!obj || !Array.isArray(obj.data)){
      alert("Ø§Ù„Ù…Ù„Ù Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©"); event.target.value=""; return;
    }
    save(obj.data);
    if(Array.isArray(obj.log)) saveLog(obj.log);
    localStorage.setItem(LAST_SYNC_KEY, JSON.stringify({type:"restore", t:Date.now()}));
    updateSyncBadge();
    render(); ensureIncomeDefaults(); calcMonthlyIncome();
    alert("ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…");
    event.target.value="";
  };

  // Ø£ÙØ¶Ù„ ØªÙˆØ§ÙÙ‚: Ø§Ø³ØªØ®Ø¯Ù… FileReaderØŒ ÙˆÙ…Ø¹Ù‡ fallback Ù„Ù€ file.text
  try{
    const reader = new FileReader();
    reader.onload = ()=>handleText(String(reader.result||""));
    reader.onerror = ()=>{
      // fallback
      if(file.text){ file.text().then(handleText).catch(()=>alert("ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù")); }
      else alert("ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù");
      event.target.value="";
    };
    reader.readAsText(file);
  }catch(e){
    if(file.text){
      file.text().then(handleText).catch(()=>alert("ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù"));
    }else{
      alert("ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù");
    }
    event.target.value="";
  }
}

function updateSyncBadge(){
  const badge=document.getElementById("syncBadge");
  const text=document.getElementById("syncText");
  if(!badge||!text) return;
  let info=null;
  try{info=JSON.parse(localStorage.getItem(LAST_SYNC_KEY)||"null");}catch{}
  if(!info||!info.t){
    text.textContent="Ø¢Ø®Ø± Ù…Ø²Ø§Ù…Ù†Ø©: -";
    badge.classList.remove("ok","warn","bad");
    return;
  }
  const dt=new Date(info.t);
  const type=info.type==="restore"?"Restore":"Backup";
  const stamp=dt.toLocaleString("ar-DZ");
  text.textContent=`Ø¢Ø®Ø± Ù…Ø²Ø§Ù…Ù†Ø©: ${type} â€” ${stamp}`;

  const ageH=(Date.now()-info.t)/3600000;
  badge.classList.remove("ok","warn","bad");
  if(ageH<=24) badge.classList.add("ok");
  else if(ageH<=72) badge.classList.add("warn");
  else badge.classList.add("bad");
}

function safeText(v){return (v===undefined||v===null||String(v).trim()==="")?"-":String(v);}
function isValidEmail(e){const s=String(e||"").trim();return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s);}
function parseISODateToUTC(iso){
  const [y,m,d]=String(iso||"").split("-").map(Number);
  if(!y||!m||!d) return null;
  return new Date(Date.UTC(y,m-1,d));
}
function addMonths(dateStr,months){
  const [y,m,d]=dateStr.split("-").map(Number);
  const dt=new Date(Date.UTC(y,m-1,d));
  const day=dt.getUTCDate();
  dt.setUTCMonth(dt.getUTCMonth()+Number(months));
  if(dt.getUTCDate()!==day) dt.setUTCDate(0);
  return dt;
}
function fmt(dt){
  const y=dt.getUTCFullYear();
  const m=String(dt.getUTCMonth()+1).padStart(2,"0");
  const d=String(dt.getUTCDate()).padStart(2,"0");
  return `${y}-${m}-${d}`;
}
function daysLeft(endUTC){
  const now=new Date();
  const todayUTC=new Date(Date.UTC(now.getUTCFullYear(),now.getUTCMonth(),now.getUTCDate()));
  return Math.ceil((endUTC.getTime()-todayUTC.getTime())/86400000);
}
function statusOf(r){
  if(!r.start||!r.months) return {status:"-",left:null,end:"-"};
  const end=addMonths(r.start,r.months);
  const left=daysLeft(end);
  let status="active";
  if(left<0) status="expired";
  else if(left<=7) status="near";
  return {status,left,end:fmt(end)};
}
function badgeHTML(st){
  if(st==="active") return `<span class="badge ok"><span class="dot"></span>Ù†Ø´Ø·</span>`;
  if(st==="near") return `<span class="badge warn"><span class="dot"></span>Ù‚Ø§Ø±Ø¨ ÙŠÙ†ØªÙ‡ÙŠ</span>`;
  if(st==="expired") return `<span class="badge bad"><span class="dot"></span>Ù…Ù†ØªÙ‡ÙŠ</span>`;
  return "-";
}
async function copyText(t){
  try{await navigator.clipboard.writeText(t);alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„");}
  catch{
    const ta=document.createElement("textarea");
    ta.value=t;document.body.appendChild(ta);
    ta.select();document.execCommand("copy");
    ta.remove();alert("ØªÙ… Ø§Ù„Ù†Ø³Ø®");
  }
}

document.addEventListener("click",(e)=>{
  if(!e.target.closest(".actions")){
    document.querySelectorAll(".menu.open").forEach(m=>m.classList.remove("open"));
  }
});

function applyFilterAndSort(data){
  const q=(search.value||"").toLowerCase().trim();
  const f=(filterStatus.value||"all");
  const s=(sort.value||"newest");

  let out=data.filter(r=>{
    const hay=`${r.name||""} ${r.email||""} ${r.plan||""} ${r.notes||""}`.toLowerCase();
    return !q||hay.includes(q);
  });

  out=out.filter(r=>f==="all"?true:statusOf(r).status===f);

  out.sort((a,b)=>{
    const sa=statusOf(a), sb=statusOf(b);
    const endA=(sa.end&&sa.end!=="-")?sa.end:"0000-00-00";
    const endB=(sb.end&&sb.end!=="-")?sb.end:"0000-00-00";
    if(s==="newest") return (b.createdAt||0)-(a.createdAt||0);
    if(s==="oldest") return (a.createdAt||0)-(b.createdAt||0);
    if(s==="end_asc") return endA.localeCompare(endB);
    if(s==="end_desc") return endB.localeCompare(endA);
    if(s==="name_asc") return (a.name||"").localeCompare(b.name||"");
    if(s==="name_desc") return (b.name||"").localeCompare(a.name||"");
    if(s==="email_asc") return (a.email||"").localeCompare(b.email||"");
    if(s==="email_desc") return (b.email||"").localeCompare(a.email||"");
    return 0;
  });
  return out;
}
function updateKPIs(all){
  let active=0,near=0,expired=0;
  all.forEach(r=>{
    const st=statusOf(r).status;
    if(st==="active") active++;
    else if(st==="near") near++;
    else if(st==="expired") expired++;
  });
  k_all.textContent=all.length;
  k_active.textContent=active;
  k_near.textContent=near;
  k_expired.textContent=expired;
}

function render(){
  const data=load();
  updateKPIs(data);
  const view=applyFilterAndSort(data);
  rows.innerHTML="";
  view.forEach(r=>{
    const realIndex=data.indexOf(r);
    const st=statusOf(r);
    const menuId=`menu_${realIndex}`;
    const emailSafe=String(r.email||"");
    const emailEsc=emailSafe.replaceAll("'","\\'");
    rows.innerHTML+=`
      <tr>
        <td>${safeText(r.name)}</td>
        <td>
          <div class="row" style="gap:8px">
            <span>${safeText(r.email)}</span>
            <button class="btn ghost" style="padding:6px 10px" onclick="copyText('${emailEsc}')">ğŸ“‹</button>
            <a class="btn ghost" style="padding:6px 10px; text-decoration:none" href="mailto:${encodeURIComponent(emailSafe)}">âœ‰ï¸</a>
          </div>
        </td>
        <td>${safeText(r.plan)}</td>
        <td>${safeText(r.price)}</td>
        <td>${safeText(r.start)}</td>
        <td>${st.end}</td>
        <td>${st.left===null?"-":st.left}</td>
        <td>${badgeHTML(st.status)}</td>
        <td>${safeText(r.notes)}</td>
        <td>
          <button class="btn" type="button" onclick="openActionsModal(${realIndex})">âš¡ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</button></td>
      </tr>`;
  });
  stats.textContent=`Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶: ${view.length} | ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø£ÙÙ‚ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ù„Ø¹Ø±Ø¶ ÙƒØ§Ù…Ù„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©`;
  calcMonthlyIncome();
}

let editingIndex=null;
function openAdd(){
  if(!canEdit()){alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„Ø¥Ø¶Ø§ÙØ©");return;}
  editingIndex=null;
  modalTitle.textContent="â• Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ùƒ";
  deleteBtn.style.display="none";
  m_name.value="";m_email.value="";m_plan.value="";m_price.value="";
  m_start.value="";m_months.value="";m_notes.value="";
  updatePreview();
  modalBack.style.display="flex";
}
function openEdit(index){
  if(!canEdit()){alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„");return;}
  const data=load();const r=data[index];if(!r) return;
  editingIndex=index;
  modalTitle.textContent="âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ø´ØªØ±Ø§Ùƒ";
  deleteBtn.style.display=canDelete()?"inline-flex":"none";
  m_name.value=r.name||"";
  m_email.value=r.email||"";
  m_plan.value=r.plan||"";
  m_price.value=r.price??0;
  m_start.value=r.start||"";
  m_months.value=r.months??1;
  m_notes.value=r.notes||"";
  updatePreview();
  modalBack.style.display="flex";
}
function closeModal(){modalBack.style.display="none";}
function validateModal(){
  if(!m_email.value.trim()) return "Ø§ÙƒØªØ¨ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ";
  if(!isValidEmail(m_email.value.trim())) return "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­";
  if(!m_start.value) return "Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„";
  if(!m_months.value||Number(m_months.value)<1) return "Ø­Ø¯Ø¯ Ù…Ø¯Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ø§Ù„Ø£Ø´Ù‡Ø±";
  return null;
}
function saveModal(){
  if(!canEdit()){alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„Ø­ÙØ¸");return;}
  const err=validateModal();if(err){alert(err);return;}
  const data=load();
  const item={
    name:m_name.value.trim(),
    email:m_email.value.trim(),
    plan:m_plan.value.trim(),
    price:Number(m_price.value||0),
    start:m_start.value,
    months:Number(m_months.value),
    notes:m_notes.value.trim(),
    createdAt:editingIndex===null?Date.now():(data[editingIndex]?.createdAt||Date.now())
  };
  const isNew=(editingIndex===null);
  if(isNew) data.push(item); else data[editingIndex]=item;
  save(data);
  if(isNew) addLog("add_payment",{amount:Number(item.price||0),plan:item.plan||"Ø¨Ø¯ÙˆÙ† Ø®Ø·Ø©",email:item.email||""});
  else addLog("edit",{email:item.email||"",plan:item.plan||"Ø¨Ø¯ÙˆÙ† Ø®Ø·Ø©"});
  closeModal();render();
}
function del(i){
  if(!canDelete()){alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„Ø­Ø°Ù");return;}
  if(!confirm("Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØŸ")) return;
  const d=load();const r=d[i];
  d.splice(i,1);save(d);
  addLog("delete",{email:r?.email||"",plan:r?.plan||"Ø¨Ø¯ÙˆÙ† Ø®Ø·Ø©"});
  render();
}
function deleteFromModal(){
  if(!canDelete()){alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„Ø­Ø°Ù");return;}
  if(editingIndex===null) return;
  del(editingIndex);closeModal();
}
function updatePreview(){
  const start=m_start.value;
  const months=Number(m_months.value||0);
  if(!start||!months){preview.textContent="Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® ÙˆÙ…Ø¯Ø© Ù„Ø¹Ø±Ø¶ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ ÙˆØ§Ù„Ù…ØªØ¨Ù‚ÙŠ.";return;}
  const end=addMonths(start,months);
  const left=daysLeft(end);
  const st=left<0?"Ù…Ù†ØªÙ‡ÙŠ":(left<=7?"Ù‚Ø§Ø±Ø¨ ÙŠÙ†ØªÙ‡ÙŠ":"Ù†Ø´Ø·");
  preview.textContent=`Ù…Ø¹Ø§ÙŠÙ†Ø©: Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ ${fmt(end)} | Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ${left} ÙŠÙˆÙ… | Ø§Ù„Ø­Ø§Ù„Ø© ${st}`;
}
["m_start","m_months"].forEach(id=>document.getElementById(id).addEventListener("input",updatePreview));

function isoTodayUTC(){
  const now=new Date();
  const d=new Date(Date.UTC(now.getUTCFullYear(),now.getUTCMonth(),now.getUTCDate()));
  return fmt(d);
}
function renew(index,addMonthsCount){
  if(!canEdit()){alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©");return;}
  const data=load();const r=data[index];if(!r) return;
  const mode=(document.getElementById("renewMode")?.value)||"end";
  const st=statusOf(r);
  let baseStart=r.start;
  if(mode==="today") baseStart=isoTodayUTC();
  else if(st.end&&st.end!=="-") baseStart=st.end;
  r.start=baseStart;
  r.months=Number(r.months||1)+Number(addMonthsCount);
  r.createdAt=r.createdAt||Date.now();
  data[index]=r;save(data);
  addLog("renew_payment",{amount:Number(r.price||0),plan:r.plan||"Ø¨Ø¯ÙˆÙ† Ø®Ø·Ø©",email:r.email||"",months_added:Number(addMonthsCount||0)});
  render();
}

// Wrapper so Actions Modal can renew reliably
function renewRow(index){
  // default: ØªÙ…Ø¯ÙŠØ¯ Ø´Ù‡Ø± ÙˆØ§Ø­Ø¯
  return renew(index, 1);
}

function renewCustom(index){
  if(!canEdit()){alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©");return;}
  const input=prompt("Ø§ÙƒØªØ¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ (Ù…Ø«Ø§Ù„: 2 Ø£Ùˆ 6 Ø£Ùˆ 24)");
  if(input===null) return;
  const n=Number(String(input).trim());
  if(!Number.isFinite(n)||n<=0||n>600){alert("Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ù‡Ø± ØºÙŠØ± ØµØ­ÙŠØ­.");return;}
  renew(index,Math.floor(n));
}
function renewWithPrice(index){
  if(!canEdit()){alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©");return;}
  const monthsInput=prompt("Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ù‡Ø± Ù„Ù„Ø¥Ø¶Ø§ÙØ© (Ù…Ø«Ø§Ù„: 1 Ø£Ùˆ 3 Ø£Ùˆ 12)");
  if(monthsInput===null) return;
  const addM=Number(String(monthsInput).trim());
  if(!Number.isFinite(addM)||addM<=0||addM>600){alert("Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ù‡Ø± ØºÙŠØ± ØµØ­ÙŠØ­.");return;}
  const priceInput=prompt("Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ)");
  if(priceInput===null) return;
  const data=load();const r=data[index];if(!r) return;
  const p=String(priceInput).trim();
  if(p!==""){
    const newPrice=Number(p);
    if(!Number.isFinite(newPrice)||newPrice<0){alert("Ø§Ù„Ø³Ø¹Ø± ØºÙŠØ± ØµØ­ÙŠØ­.");return;}
    r.price=newPrice;data[index]=r;save(data);
    addLog("price_change",{email:r.email||"",plan:r.plan||"Ø¨Ø¯ÙˆÙ† Ø®Ø·Ø©",amount:newPrice});
  }
  renew(index,Math.floor(addM));
}

function exportCSV(){
  const data=load();
  // Excel-friendly CSV: BOM + semicolon delimiter + CRLF
  const header=["name","email","plan","price","start","months","notes"];
  const delim=";";
  const lines=[header.join(delim)].concat(
    data.map(r=>header.map(h=>{
      const v = String(r[h]??"");
      return `"${v.replaceAll('"','""')}"`;
    }).join(delim))
  ).join("\r\n");
  const blob=new Blob(["\ufeff"+lines],{type:"text/csv;charset=utf-8"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;a.download="subscriptions.csv";
  document.body.appendChild(a);a.click();a.remove();
  URL.revokeObjectURL(url);
}
function importCSV(event){
  if(!canImportClear()){alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯");event.target.value="";return;}
  const file=event.target.files&&event.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onerror = ()=>{ alert("ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù"); event.target.value=""; };
  reader.onload = ()=>{
    try{
      const text = String(reader.result||"");
      const rows = parseCSV(text);

      const cleaned = rows.map(r=>({
        name: String(r.name||"").trim(),
        email: String(r.email||"").trim(),
        plan: String(r.plan||"").trim(),
        price: Number(String(r.price||"").replace(",", ".")) || 0,
        start: normalizeDate(String(r.start||"").trim()),
        months: Number(r.months||1) || 1,
        notes: String(r.notes||"").trim(),
        createdAt: Date.now()
      })).filter(r=>r.email && r.start);

      if(!cleaned.length){
        alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØµÙÙˆÙ ØµØ§Ù„Ø­Ø©. ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© (email/start) Ø£Ùˆ Ø§Ù„ÙØ§ØµÙ„ (, Ø£Ùˆ ;).");
        event.target.value="";
        return;
      }

      save(cleaned);
      addLog("import",{count:cleaned.length});
      render();
      alert("âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ CSV Ø¨Ù†Ø¬Ø§Ø­: " + cleaned.length);
    }catch(e){
      alert("Ø®Ø·Ø£ ÙÙŠ CSV: " + (e && e.message ? e.message : "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"));
    }
    event.target.value="";
  };
  reader.readAsText(file, "utf-8");
}
function parseCSV(text){
  // Remove BOM
  text = (text||"").replace(/^\uFEFF/,"");
  const lines=text.split(/\r?\n/).filter(l=>l.trim().length);
  if(!lines.length) return [];

  // Detect delimiter from header line
  const hline = lines[0];
  const counts = {
    ",": (hline.match(/,/g)||[]).length,
    ";": (hline.match(/;/g)||[]).length,
    "\t": (hline.match(/\t/g)||[]).length
  };
  let delim = ",";
  if(counts[";"]>counts[","] && counts[";"]>=1) delim=";";
  else if(counts["\t"]>counts[","] && counts["\t"]>=1) delim="\t";

  const rawHeader=splitLine(hline, delim).map(h=>h.trim());
  const header = rawHeader.map(h=>mapCSVHeader(h));

  const out=[];
  for(let i=1;i<lines.length;i++){
    const cols=splitLine(lines[i], delim);
    const obj={};
    header.forEach((h,idx)=>{
      if(!h) return;
      obj[h]=(cols[idx]??"");
    });
    out.push(obj);
  }
  return out;
}

function splitLine(line, delim){
  const res=[];let cur="";let inQ=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch=='"'){
      if(inQ && line[i+1]=='"'){cur+='"';i++;}
      else inQ=!inQ;
    }else if(ch===delim && !inQ){
      res.push(cur);cur="";
    }else{
      cur+=ch;
    }
  }
  res.push(cur);
  return res;
}

function mapCSVHeader(h){
  // normalize: lowercase, remove spaces/underscores, arabic normalize
  const s=(h||"").toString().trim().toLowerCase();
  const n=s.replace(/[\s_]+/g,"");
  const ar=n
    .replace(/[Ø£Ø¥Ø¢]/g,"Ø§")
    .replace(/Ø©/g,"Ù‡")
    .replace(/Ù‰/g,"ÙŠ");

  // English keys
  const table = {
    "name":"name","clientname":"name","customername":"name",
    "email":"email","mail":"email","e-mail":"email",
    "plan":"plan","plantype":"plan","subscriptionplan":"plan",
    "price":"price","amount":"price","cost":"price",
    "start":"start","startdate":"start","registerdate":"start","date":"start",
    "months":"months","duration":"months","period":"months",
    "notes":"notes","note":"notes","comment":"notes","remarks":"notes"
  };
  if(table[n]) return table[n];

  // Arabic headers (common)
  const arTable = {
    "Ø§Ø³Ù…Ø§Ù„Ø¹Ù…ÙŠÙ„":"name","Ø§Ù„Ø§Ø³Ù…":"name","Ø§Ø³Ù…":"name",
    "Ø§Ù„Ø¨Ø±ÙŠØ¯Ø§Ù„Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠ":"email","Ø§Ù„Ø¨Ø±ÙŠØ¯":"email","Ø§ÙŠÙ…ÙŠÙ„":"email","email":"email",
    "Ù†ÙˆØ¹Ø§Ù„Ø®Ø·Ø©":"plan","Ø§Ù„Ø®Ø·Ø©":"plan","Ù†ÙˆØ¹Ø§Ù„Ø®Ø·Ù‡":"plan",
    "Ø³Ø¹Ø±":"price","Ø§Ù„Ø³Ø¹Ø±":"price","Ø§Ù„Ù…Ø¨Ù„Øº":"price",
    "ØªØ§Ø±ÙŠØ®Ø§Ù„ØªØ³Ø¬ÙŠÙ„":"start","ØªØ§Ø±ÙŠØ®Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©":"start","Ø¨Ø¯Ø§ÙŠØ©":"start",
    "Ø§Ù„Ù…Ø¯Ø©":"months","Ù…Ø¯Ù‡":"months","Ù…Ø¯Ø©Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ":"months","Ù…Ø¯Ù‡Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ":"months","Ø§Ø´Ù‡Ø±":"months",
    "Ù…Ù„Ø§Ø­Ø¸Ø§Øª":"notes","Ù…Ù„Ø§Ø­Ø¸Ù‡":"notes"
  };
  if(arTable[ar]) return arTable[ar];

  // If header is already one of our keys
  if(["name","email","plan","price","start","months","notes"].includes(s)) return s;

  return ""; // ignore unknown columns
}

function normalizeDate(s){
  s=(s||"").trim();
  if(!s) return "";
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

  // DD/MM/YYYY or D/M/YYYY
  let m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
  if(m){
    const dd = String(m[1]).padStart(2,"0");
    const mm = String(m[2]).padStart(2,"0");
    const yy = m[3];
    return `${yy}-${mm}-${dd}`;
  }

  // YYYY/MM/DD
  m = s.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
  if(m){
    const yy=m[1];
    const mm=String(m[2]).padStart(2,"0");
    const dd=String(m[3]).padStart(2,"0");
    return `${yy}-${mm}-${dd}`;
  }

  return s;
}
function clearAll(){
  if(!canImportClear()){alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„");return;}
  if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ")) return;
  localStorage.removeItem(KEY);
  addLog("clear_all",{});
  render();
}

function monthRangeUTC(yyyy_mm){
  const [y,m]=String(yyyy_mm||"").split("-").map(Number);
  if(!y||!m) return null;
  const start=new Date(Date.UTC(y,m-1,1));
  const end=new Date(Date.UTC(y,m,1));
  return {start,end,y,m};
}
function ensureIncomeDefaults(){
  const now=new Date();
  const y=now.getFullYear();
  const m=String(now.getMonth()+1).padStart(2,"0");
  const el=document.getElementById("incomeMonth");
  if(el && !el.value) el.value=`${y}-${m}`;
}
function getCurrency(){
  const c=document.getElementById("currency")?.value||"DZD";
  if(c==="custom"){
    const v=(document.getElementById("customCurrency")?.value||"").trim();
    return v||"CUR";
  }
  return c;
}
(function wireCurrency(){
  const sel=document.getElementById("currency");
  const custom=document.getElementById("customCurrency");
  if(!sel||!custom) return;
  sel.addEventListener("change",()=>{custom.style.display=(sel.value==="custom")?"inline-block":"none";});
}
function money(n){
  const x=Number(n||0);
  const cur=getCurrency();
  return `${x.toLocaleString("ar-DZ",{maximumFractionDigits:2})} ${cur}`;
}
function ymStr(date){
  const y=date.getUTCFullYear();
  const m=String(date.getUTCMonth()+1).padStart(2,"0");
  return `${y}-${m}`;
}
function monthStartUTC(y,m){return new Date(Date.UTC(y,m-1,1));}

function calcIncomeForMonth(mode,ym){
  const range=monthRangeUTC(ym);
  if(!range) return {total:0,count:0,byPlan:new Map()};
  let total=0,count=0; const byPlan=new Map();
  const data=load(); const log=loadLog();

  if(mode==="payments"){
    const start=range.start.getTime(), end=range.end.getTime();
    for(const e of log){
      if(e.t>=start && e.t<end && (e.action==="renew_payment"||e.action==="add_payment")){
        const amount=Number(e.amount||0);
        const plan=(e.plan&&String(e.plan).trim())?String(e.plan).trim():"Ø¨Ø¯ÙˆÙ† Ø®Ø·Ø©";
        total+=amount; count+=1;
        const prev=byPlan.get(plan)||{count:0,sum:0};
        prev.count+=1; prev.sum+=amount;
        byPlan.set(plan,prev);
      }
    }
    return {total,count,byPlan};
  }

  for(const r of data){
    const price=Number(r.price||0);
    const months=Number(r.months||0);
    const startDt=parseISODateToUTC(r.start);
    if(!startDt||!months||months<1) continue;
    const endDt=addMonths(r.start,months);
    const plan=(r.plan&&String(r.plan).trim())?String(r.plan).trim():"Ø¨Ø¯ÙˆÙ† Ø®Ø·Ø©";
    let contribution=0, include=false;
    if(mode==="start"){
      if(startDt>=range.start && startDt<range.end){include=true; contribution=price;}
    } else {
      const overlaps=(startDt<range.end) && (endDt>range.start);
      if(overlaps){include=true; contribution=price/months;}
    }
    if(include){
      total+=contribution; count+=1;
      const prev=byPlan.get(plan)||{count:0,sum:0};
      prev.count+=1; prev.sum+=contribution;
      byPlan.set(plan,prev);
    }
  }
  return {total,count,byPlan};
}

function drawIncomeChart(points){
  const canvas=document.getElementById("incomeChart"); if(!canvas) return;
  const ctx=canvas.getContext("2d");
  const w=canvas.clientWidth, h=canvas.height;
  canvas.width=Math.floor(w*devicePixelRatio);
  canvas.height=Math.floor(h*devicePixelRatio);
  ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
  ctx.clearRect(0,0,w,h);

  const pad=14, chartW=w-pad*2, chartH=h-pad*2;
  const vals=points.map(p=>p.value);
  const maxV=Math.max(1,...vals);

  ctx.globalAlpha=0.25; ctx.strokeStyle="#ffffff"; ctx.lineWidth=1;
  for(let i=0;i<=3;i++){
    const yy=pad+(chartH*i/3);
    ctx.beginPath();ctx.moveTo(pad,yy);ctx.lineTo(pad+chartW,yy);ctx.stroke();
  }
  ctx.globalAlpha=1;
  ctx.strokeStyle="#ffffff"; ctx.lineWidth=2;
  ctx.beginPath();
  points.forEach((p,i)=>{
    const x=pad+(chartW*(i/(points.length-1||1)));
    const y=pad+chartH-(p.value/maxV)*chartH;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();
  ctx.fillStyle="#ffffff";
  points.forEach((p,i)=>{
    const x=pad+(chartW*(i/(points.length-1||1)));
    const y=pad+chartH-(p.value/maxV)*chartH;
    ctx.beginPath();ctx.arc(x,y,3,0,Math.PI*2);ctx.fill();
  });
  ctx.fillStyle="rgba(255,255,255,.75)";
  ctx.font="12px system-ui";
  points.forEach((p,i)=>{
    const x=pad+(chartW*(i/(points.length-1||1)));
    ctx.fillText(p.label,Math.max(2,x-10),h-2);
  });
}

function calcMonthlyIncome(){
  try{ if(window.__showIncomeChart) window.__showIncomeChart(); }catch(e){}
  const month=document.getElementById("incomeMonth")?.value;
  const mode=document.getElementById("incomeMode")?.value||"start";
  if(!month) return;
  const res=calcIncomeForMonth(mode,month);
  incomeTotal.textContent=money(res.total);
  incomeCount.textContent=(res.count||0).toLocaleString("ar-DZ");
  incomeAvg.textContent=money(res.count?(res.total/res.count):0);

  incomeHint.textContent=
    (mode==="start")?"Ø­Ø³Ø¨ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø§Ù„ØªÙŠ Ø¨Ø¯Ø£Øª Ø¯Ø§Ø®Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±."
    :(mode==="spread")?"Ù…ÙˆØ²Ù‘Ø¹: (Ø§Ù„Ø³Ø¹Ø± Ã· Ù…Ø¯Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ) Ù„Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø§Ù„ØªÙŠ ØªØºØ·ÙŠ Ø§Ù„Ø´Ù‡Ø±."
    :"Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø¯Ø§Ø®Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.";

  let topPlan="-", topSum=-Infinity;
  for(const [plan,obj] of res.byPlan.entries()){
    if(obj.sum>topSum){topSum=obj.sum; topPlan=plan;}
  }
  incomeTopPlan.textContent=topPlan;

  incomePlanRows.innerHTML="";
  const planRows=Array.from(res.byPlan.entries()).sort((a,b)=>b[1].sum-a[1].sum);
  for(const [plan,obj] of planRows){
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${plan}</td><td>${obj.count}</td><td>${money(obj.sum)}</td>`;
    incomePlanRows.appendChild(tr);
  }
  if(planRows.length===0){
    incomePlanRows.innerHTML=`<tr><td colspan="3" class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.</td></tr>`;
  }

  const range=monthRangeUTC(month);
  if(range){
    const base=monthStartUTC(range.y,range.m);
    const points=[];
    for(let i=5;i>=0;i--){
      const d=new Date(base);
      d.setUTCMonth(d.getUTCMonth()-i);
      const ym=ymStr(d);
      const rr=calcIncomeForMonth(mode,ym);
      points.push({label:ym.slice(5), value:rr.total});
    }
    chartHint.textContent=`Ø§Ù„ÙˆØ¶Ø¹: ${mode}`;
    drawIncomeChart(points);
  }
}

function openPwModal(){
  const role=getRole();
  if(role!=="admin" && role!=="staff"){alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±");return;}
  document.getElementById("pw_current").value="";
  document.getElementById("pw_new").value="";
  document.getElementById("pw_new2").value="";
  const target=document.getElementById("pw_target");
  target.value="self";
  target.querySelector('option[value="all"]').disabled=(role!=="admin");
  document.getElementById("pwBack").style.display="flex";
}
function closePwModal(e){
  if(e && e.target && e.target.id!=="pwBack") return;
  document.getElementById("pwBack").style.display="none";
}
async function saveNewPassword(){
  const role=getRole();
  const currentUser=role==="admin"?"admin":(role==="staff"?"staff":"viewer");
  const cur=(document.getElementById("pw_current").value||"").trim();
  const nw=(document.getElementById("pw_new").value||"").trim();
  const nw2=(document.getElementById("pw_new2").value||"").trim();
  const target=document.getElementById("pw_target").value;
  if(!cur||!nw||!nw2){alert("Ø§Ù…Ù„Ø£ ÙƒÙ„ Ø§Ù„Ø®Ø§Ù†Ø§Øª");return;}
  if(nw.length<6){alert("Ø§Ø®ØªØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø£Ø·ÙˆÙ„ (6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)");return;}
  if(nw!==nw2){alert("Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ù„Ø§ ÙŠØ·Ø§Ø¨Ù‚ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©");return;}
  const users=loadUsers();
  const me=users.find(x=>x.username===currentUser);
  if(!me||!me.passHash){alert("Ù„Ù… ÙŠØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ø¹Ø¯.");return;}
  const curHash=await sha256Base64(cur);
  if(curHash!==me.passHash){alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©");return;}
  const newHash=await sha256Base64(nw);
  if(target==="all"){
    if(role!=="admin"){alert("ÙÙ‚Ø· admin ÙŠÙ…ÙƒÙ†Ù‡ Ø§Ù„ØªØºÙŠÙŠØ± Ù„Ù„Ø¬Ù…ÙŠØ¹");return;}
    saveUsers(users.map(x=>({...x,passHash:newHash})));
    alert("ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ø¬Ù…ÙŠØ¹ âœ…");
  }else{
    saveUsers(users.map(x=>x.username===currentUser?({...x,passHash:newHash}):x));
    alert("ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± âœ…");
  }
  closePwModal();
}


function setSyncBtnVisible(v){
  const b=document.getElementById("syncMenuBtn");
  if(!b) return;
  b.style.display = v ? "inline-flex" : "none";
}

function openSyncMenu(){
  try{ closeActions(); }catch{}
  try{ closeRemind(); }catch{}
  try{ closeSyncHelp(); }catch{}
  const b=document.getElementById("syncMenuBack");
  if(b) b.style.display="flex";
}
function closeSyncMenu(e){
  if(e && e.target && e.target.id!=="syncMenuBack") return;
  const b=document.getElementById("syncMenuBack");
  if(b) b.style.display="none";
}

function openSyncHelp(){
  const back=document.getElementById("syncHelpBack");
  if(back) back.style.display="flex";
}
function closeSyncHelp(e){
  if(e && e.target && e.target.id!=="syncHelpBack") return;
  const back=document.getElementById("syncHelpBack");
  if(back) back.style.display="none";
}
function wireAutoBackupToggle(){
  const t=document.getElementById("autoBackupToggle");
  if(!t) return;
  const enabled=localStorage.getItem(AUTO_BACKUP_KEY);
  t.checked = (enabled!== "0"); // Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù…ÙØ¹Ù„
  t.addEventListener("change",()=>{
    localStorage.setItem(AUTO_BACKUP_KEY, t.checked ? "1" : "0");
  });
}
function maybeRemindBackup(){
  const enabled=localStorage.getItem(AUTO_BACKUP_KEY);
  if(enabled==="0") return;
  let info=null;
  try{info=JSON.parse(localStorage.getItem(LAST_SYNC_KEY)||"null");}catch{}
  const lastT = info && info.t ? Number(info.t) : 0;
  const day = 24*60*60*1000;
  if(!lastT || (Date.now()-lastT) > day){
    // ØªØ°ÙƒÙŠØ± Ù„Ø·ÙŠÙ Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙ‚Ø·
    setTimeout(()=>{
      const msg = "ğŸ”” ØªØ°ÙƒÙŠØ±: Ù…Ø±Ù‘ Ø£ÙƒØ«Ø± Ù…Ù† ÙŠÙˆÙ… Ø¨Ø¯ÙˆÙ† Backup/Restore. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¹Ù…Ù„ Backup Ø§Ù„Ø¢Ù†ØŸ";
      if(confirm(msg)){
        backupJSON();
      }
    }, 800);
  }
}

function bootLocal(){
  updateSyncBadge();
  if(getRole()){
    bootAuthed();
  }else{
    const users=loadUsers();
    const ready=users.every(u=>u.passHash && u.passHash.length>10);
    lockMsg.textContent=ready?"Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ.":"Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø¹Ø¯Ø§Ø¯ ÙƒÙ„Ù…Ø§Øª Ù…Ø±ÙˆØ± Ø¨Ø¹Ø¯. Ø§ÙØªØ­ (Ø¥Ø¹Ø¯Ø§Ø¯ Ø£ÙˆÙ„ Ù…Ø±Ø©) ÙˆØ§Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯.";
  }
}

function toggleChartSwitch(show){
  const w=document.getElementById("chartWrap");
  if(!w) return;
  w.style.display = show ? "block" : "none";
  try{
    if(show && typeof calcMonthlyIncome==="function"){
      setTimeout(calcMonthlyIncome,100);
    }
  }catch(e){}
}


function initChartToggle(){
  // Ø§Ø¨Ø¯Ø£ Ø¯Ø§Ø¦Ù…Ù‹Ø§ Ù…Ø®ÙÙŠÙ‹Ø§ Ø­ØªÙ‰ ÙŠÙØ¹Ù‘Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø³ÙˆÙŠØªØ´Ø±
  toggleChartSwitch(false);
}
window.addEventListener("load", initChartToggle);

function toggleChartSwitch(show){
  const w=document.getElementById("chartWrap");
  if(!w) return;
  w.style.display = show ? "block" : "none";

  // Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ø¥Ø®ÙØ§Ø¡: Ø§Ù…Ø³Ø­ Ø§Ù„Ø±Ø³Ù…/ÙˆØ¯Ù…Ù‘Ø± Ø§Ù„Ø´Ø§Ø±Øª Ø¥Ù† ÙˆÙØ¬Ø¯
  if(!show){
    try{ if(window.incomeChart){ window.incomeChart.destroy(); window.incomeChart=null; } }catch(e){}
    try{
      const c=document.getElementById("incomeChart");
      if(c && c.getContext){ const ctx=c.getContext("2d"); ctx.clearRect(0,0,c.width,c.height); }
    }catch(e){}
    return;
  }

  // Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ø¥Ø¸Ù‡Ø§Ø±: Ø§Ø­Ø³Ø¨/Ø§Ø±Ø³Ù… Ø¨Ø¹Ø¯ Ø£Ù† ÙŠØ£Ø®Ø° Ø§Ù„Ù…Ù‚Ø§Ø³
  try{
    if(typeof calcMonthlyIncome==="function"){
      setTimeout(calcMonthlyIncome,150);
    }
  }catch(e){}
}

// Ø§Ù…Ù†Ø¹ Ø±Ø³Ù… Ø§Ù„Ù…Ù†Ø­Ù†Ù‰ Ø¥Ø°Ø§ Ø§Ù„Ø³ÙˆÙŠØªØ´Ø± OFF
(function(){
  const _orig = window.calcMonthlyIncome;
  if(typeof _orig === "function" && !window.__patchedCalcMonthlyIncome){
    window.__patchedCalcMonthlyIncome = true;
    window.calcMonthlyIncome = function(){
      const cb=document.getElementById("chartToggle");
      if(cb && !cb.checked) return; // Ù„Ø§ ØªØ±Ø³Ù… Ø¥Ù„Ø§ Ø¥Ø°Ø§ Ù…ÙÙØ¹Ù‘Ù„
      return _orig.apply(this, arguments);
    };
  }
  window.addEventListener("load", ()=>{ toggleChartSwitch(false); });
}


// Close actions dropdown after choosing an option
document.addEventListener('click', (e)=>{
  const btn = e.target.closest && e.target.closest('.actionsDetails .menuDetails button');
  if(btn){
    const d = btn.closest('details');
    if(d) d.removeAttribute('open');
  }
});


// --- Actions Modal logic ---
let __actionsIdx = null;

function openActionsModal(idx){
  __actionsIdx = idx;
  const back=document.getElementById("actionsModalBack");
  const sub=document.getElementById("actionsModalSub");
  try{
    const data=load();
    const row=data && data[idx] ? data[idx] : null;
    if(sub) sub.textContent = row ? (`${row.name||"Ø¹Ù…ÙŠÙ„"} â€” ${row.email||""}`) : "";
  }catch(e){
    if(sub) sub.textContent = "";
  }
  if(back){ back.style.display="flex"; }
  try{ const rb=document.getElementById("renewBox"); if(rb) rb.style.display="none"; }catch(e){}
}

function closeActionsModal(){
  const back=document.getElementById("actionsModalBack");
  if(back) back.style.display="none";
  __actionsIdx = null;
}

function actionsDo(kind){
  const idx=__actionsIdx;
  if(idx===null || idx===undefined) return;

  // Ø­Ø§ÙˆÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø­Ø³Ø¨ Ø§Ù„Ù…ØªÙˆÙØ±
  try{
    if(kind==="edit"){
      if(typeof openEdit === "function") openEdit(idx);
      else if(typeof editRow === "function") editRow(idx);
      else if(typeof editItem === "function") editItem(idx);
      else alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø§Ù„Ø© ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø©.");
    }else if(kind==="renew"){
      if(typeof renewRow === "function") renewRow(idx);
      else if(typeof renew === "function") renew(idx,1);
      else if(typeof renewItem === "function") renewItem(idx);
      else if(typeof extendSub === "function") extendSub(idx);
      else alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø§Ù„Ø© ØªØ¬Ø¯ÙŠØ¯ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø©.");
    }else if(kind==="delete"){
      if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ")){
        if(typeof deleteRow === "function") deleteRow(idx);
        else if(typeof removeRow === "function") removeRow(idx);
        else if(typeof delSub === "function") delSub(idx);
        else alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø§Ù„Ø© Ø­Ø°Ù ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø©.");
      }else{
        return;
      }
    }else if(kind==="copy"){
      try{
        const data=load();
        const row=data && data[idx] ? data[idx] : null;
        const email=row ? (row.email||"") : "";
        if(!email){ alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Email Ù„Ù†Ø³Ø®Ù‡"); return; }
        if(navigator.clipboard && navigator.clipboard.writeText){
          navigator.clipboard.writeText(email).then(()=>alert("âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®")).catch(()=>fallbackCopy(email));
        }else fallbackCopy(email);
      }catch(e){
        alert("ØªØ¹Ø°Ø± Ø§Ù„Ù†Ø³Ø®");
      }
    }
  }finally{
    closeActionsModal();
    try{ render && render(); }catch(e){}
  }
}

function fallbackCopy(text){
  const ta=document.createElement("textarea");
  ta.value=text; document.body.appendChild(ta);
  ta.select(); ta.setSelectionRange(0, 99999);
  try{ document.execCommand("copy"); alert("âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®"); }catch(e){ alert("ØªØ¹Ø°Ø± Ø§Ù„Ù†Ø³Ø®"); }
  ta.remove();
}

// Close modal when clicking backdrop
document.addEventListener("click", (e)=>{
  const back=document.getElementById("actionsModalBack");
  if(!back || back.style.display==="none") return;
  if(e.target === back) closeActionsModal();
}, {capture:true});



// Guard: Ù„Ø§ ØªÙ‚Ù… Ø¨Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ ÙØªØ­ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯
function __isRenewBoxOpen(){
  const rb = document.getElementById("renewBox");
  return rb && rb.style.display !== "none";
}

// --- Renew options handlers ---
let __renewMonths = 1;

function showRenewOptions(){
  const box = document.getElementById("renewBox");
  if(!box) return;
  box.style.display = "block";
  __renewMonths = 1;
  // reset chips
  box.querySelectorAll(".chip").forEach(c=>c.classList.remove("active"));
  const first = box.querySelector('.chip[data-m="1"]');
  if(first) first.classList.add("active");
  const input = document.getElementById("renewMonthsInput");
  if(input) input.value = "";
}

document.addEventListener("click", (e)=>{
  const chip = e.target.closest && e.target.closest("#renewBox .chip");
  if(!chip) return;
  const m = parseInt(chip.getAttribute("data-m")||"1", 10);
  if(!Number.isFinite(m) || m<1) return;
  __renewMonths = m;
  chip.parentElement.querySelectorAll(".chip").forEach(c=>c.classList.remove("active"));
  chip.classList.add("active");
  const input = document.getElementById("renewMonthsInput");
  if(input) input.value = "";
}, {capture:true});

function confirmRenew(){
  if(!__isRenewBoxOpen()){ return; }
  const idx = __actionsIdx;
  if(idx===null || idx===undefined) return;

  const input = document.getElementById("renewMonthsInput");
  let months = __renewMonths;

  if(input && input.value){
    const v = parseInt(input.value, 10);
    if(!Number.isFinite(v) || v<1){
      alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­ (>= 1)");
      return;
    }
    months = v;
  }
  // Prefer built-in renew(index, months)
  if(typeof renew === "function") renew(idx, months);
  else if(typeof renewRow === "function") renewRow(idx); // fallback (1 month)
  else alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø§Ù„Ø© ØªØ¬Ø¯ÙŠØ¯ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø©.");

  closeActionsModal();
  try{ render && render(); }catch(e){}
}


function shareBackup(){
  // Ù…Ø´Ø§Ø±ÙƒØ© Ù…Ù„Ù backup.json Ø¹Ø¨Ø± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¥Ù† ÙˆÙØ¬Ø¯Øª
  try{
    const payload={exportedAt:new Date().toISOString(),data:load(),log:loadLog()};
    const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json;charset=utf-8"});
    const file=new File([blob],"backup.json",{type:"application/json"});
    if(navigator.share){
      navigator.share({files:[file], title:"Backup", text:"backup.json"});
    }else{
      // fallback: ØªÙ†Ø²ÙŠÙ„
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a");
      a.href=url;a.download="backup.json";
      document.body.appendChild(a);a.click();a.remove();
      URL.revokeObjectURL(url);
    }
    localStorage.setItem(LAST_SYNC_KEY, JSON.stringify({type:"backup", t:Date.now()}));
    updateSyncBadge();
  }catch(e){
    alert("ØªØ¹Ø°Ø± Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©");
  }
}

</script>

<div class="modalBack" id="syncMenuBack" onclick="closeSyncMenu(event)">
  <div class="modal" onclick="event.stopPropagation()" style="max-width:560px">
    <div class="modalHeader">
      <h3>â˜ï¸ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ÙˆØ§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h3>
      <button class="btn ghost" onclick="closeSyncMenu()">âœ–</button>
    </div>

    <div class="card" style="margin:0; padding:10px">
      <div style="display:flex;flex-direction:column;gap:8px;max-height:62vh;overflow:auto;padding:4px">

        <div class="muted" style="margin-bottom:2px">ğŸ“¦ Ø§Ù„Ù†Ø³Ø® ÙˆØ§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹</div>
        <button class="btn" onclick="backupJSON(); closeSyncMenu()">ğŸ’¾ Backup (ØªÙ†Ø²ÙŠÙ„)</button>
        <button class="btn" onclick="shareBackup(); closeSyncMenu()">ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ© Backup</button>
        <button class="btn" onclick="document.getElementById('restoreFile').click(); closeSyncMenu()">ğŸ“¥ Restore (Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù)</button>
<div style="height:1px;background:rgba(255,255,255,.10);margin:6px 2px"></div>

        <div class="muted" style="margin-bottom:2px">â˜ï¸ Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØªØ®Ø²ÙŠÙ†</div>
        <button class="btn" onclick="window.open('https://drive.google.com/drive/my-drive','_blank','noopener'); closeSyncMenu()">ğŸ“‚ ÙØªØ­ Google Drive</button>
        <button class="btn" onclick="window.open('https://www.dropbox.com/home','_blank','noopener'); closeSyncMenu()">ğŸ“‚ ÙØªØ­ Dropbox</button>

        <div style="height:1px;background:rgba(255,255,255,.10);margin:6px 2px"></div>

        <div class="muted" style="margin-bottom:2px">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆÙ…Ø³Ø§Ø¹Ø¯Ø©</div>
        

      </div>
      <p class="muted" style="margin:10px 6px 0; line-height:1.8">
        Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ø¯ÙˆÙ† Ø³ÙŠØ±ÙØ± ØªÙƒÙˆÙ† Ø¹Ø¨Ø± Ù…Ù„Ù <b>backup.json</b> (Backup â†’ Ù…Ø´Ø§Ø±ÙƒØ©/Ø±ÙØ¹ â†’ Restore).
      </p>
    </div>

    <div class="row" style="margin-top:12px">
      <button class="btn" onclick="closeSyncMenu()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<input type="file" id="restoreFile" accept="application/json" style="display:none" onchange="restoreJSON(event)">


<!-- Actions Modal -->
<div id="actionsModalBack" class="modalBack" style="display:none">
  <div class="modal">
    <div class="modalHead">
      <div class="modalTitle">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</div>
      <button class="iconBtn" type="button" onclick="closeActionsModal()">âœ•</button>
    </div>
    <div class="modalBody">
      <div class="muted" id="actionsModalSub" style="margin-bottom:10px"></div>
      <div class="modalGrid">
      <button class="btn" type="button" onclick="actionsDo('edit')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
      <button class="btn" type="button" onclick="showRenewOptions()">ğŸ” ØªØ¬Ø¯ÙŠØ¯</button>
      <button class="btn danger" type="button" onclick="actionsDo('delete')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
      <button class="btn secondary" type="button" onclick="actionsDo('copy')">ğŸ“‹ Ù†Ø³Ø® Email</button>
</div>
    <div id="renewBox" class="renewBox" style="display:none">
      <div class="renewTitle">Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¯Ø© Ø§Ù„ØªØ¬Ø¯ÙŠØ¯</div>
      <div class="renewChips">
        <button class="chip" type="button" data-m="1">Ø´Ù‡Ø±</button>
        <button class="chip" type="button" data-m="3">3 Ø£Ø´Ù‡Ø±</button>
        <button class="chip" type="button" data-m="6">6 Ø£Ø´Ù‡Ø±</button>
      </div>
      <div class="renewManual">
        <label class="renewLabel">Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø¨Ø§Ù„Ø£Ø´Ù‡Ø±</label>
        <div class="renewRow">
          <input id="renewMonthsInput" class="renewInput" type="number" inputmode="numeric" min="1" max="120" placeholder="Ù…Ø«Ø§Ù„: 2" />
          <button class="btn" type="button" onclick="confirmRenew()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯</button>
        </div>
        <div class="renewHint">Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¯Ø© Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø­Ø§Ù„ÙŠ.</div>
      </div>
    </div>
</div>
      <div style="margin-top:12px">
        <button class="btn secondary" style="width:100%" type="button" onclick="closeActionsModal()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>
</div>


<!-- ================= Firebase Login (Email/Password) ================= -->
<div id="loginBack" style="display:flex;position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:99999;align-items:center;justify-content:center;padding:16px">
  <div style="width:min(420px,96vw);background:#0f172a;border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:18px;color:#e5e7eb">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <strong>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</strong>
    </div>

    <div style="display:grid;gap:10px">
      <input id="loginEmail" type="email" placeholder="Email"
        style="padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.25);color:#fff;outline:none">

      <input id="loginPass" type="password" placeholder="Password"
        style="padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.25);color:#fff;outline:none">

      <button id="btnLogin" type="button"
        style="padding:10px;border-radius:12px;border:0;background:#3b82f6;color:white;cursor:pointer">
        Ø¯Ø®ÙˆÙ„
      </button>

      <button id="btnCreate" type="button"
        style="padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.2);background:transparent;color:white;cursor:pointer">
        Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)
      </button>

      <div id="loginMsg" style="color:#fca5a5;font-size:13px;min-height:18px">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>
  </div>
</div>

<button id="btnLogout" class="btn secondary" type="button"
  style="display:none;position:fixed;bottom:14px;left:14px;z-index:9999">
  ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
</button>


<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script>
  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ
  const firebaseConfig = {
    apiKey: "AIzaSyCTFWu05DqfkiSN_0vGSb6CpAwGJ5lMoC0",
    authDomain: "stok-ef86f.firebaseapp.com",
    projectId: "stok-ef86f",
    storageBucket: "stok-ef86f.firebasestorage.app",
    messagingSenderId: "845285269041",
    appId: "1:845285269041:web:4bdb61a61aa114d600ff10",
    measurementId: "G-EBF3TC1QWT"
  };

  // init once
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();

  // ===== Allowlist (ØªÙ‚ÙŠÙŠØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù„Ù‰ Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª Ù…Ø­Ø¯Ø¯Ø©) =====
  // ÙŠØªÙ… ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø¬Ù‡Ø§Ø² (LocalStorage)
  const ALLOW_KEY = "firebase_allowed_emails_v1";
  function normEmail(x){ return String(x||"").trim().toLowerCase(); }
  function getAllowed(){
    try{ const v = JSON.parse(localStorage.getItem(ALLOW_KEY)); return Array.isArray(v)? v: []; }
    catch(e){ return []; }
  }
  function setAllowed(arr){ localStorage.setItem(ALLOW_KEY, JSON.stringify(arr)); }
  function isAllowedEmail(email){
    const list = getAllowed().map(normEmail).filter(Boolean);
    if(!list.length) return true; // ÙØ§Ø±ØºØ© = Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ø¬Ù…ÙŠØ¹
    return list.includes(normEmail(email));
  }

  // ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
  window.refreshAllowedUI = function(){
    const ul = document.getElementById("allowedList");
    if(!ul) return;
    ul.innerHTML = "";
    const arr = getAllowed().map(normEmail).filter(Boolean);
    if(!arr.length){
      const li = document.createElement("li");
      li.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ Ø¥ÙŠÙ…ÙŠÙ„ Ù…Ø¶Ø§Ù (Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ø¬Ù…ÙŠØ¹).";
      ul.appendChild(li);
      return;
    }
    arr.forEach((em, i)=>{
      const li = document.createElement("li");
      li.style.margin = "6px 0";
      li.textContent = em + " ";
      const b = document.createElement("button");
      b.type = "button";
      b.textContent = "Ø­Ø°Ù";
      b.style.marginInlineStart = "8px";
      b.style.padding = "4px 10px";
      b.style.borderRadius = "10px";
      b.style.border = "1px solid rgba(255,255,255,.15)";
      b.style.background = "transparent";
      b.style.color = "#fff";
      b.style.cursor = "pointer";
      b.onclick = ()=>{
        const a = getAllowed().map(normEmail).filter(Boolean);
        a.splice(i,1);
        setAllowed(a);
        refreshAllowedUI();
      };
      li.appendChild(b);
      ul.appendChild(li);
    });
  }

  window.openAllowlist = function(){
    refreshAllowedUI();
    const m = document.getElementById("allowlistModal");
    if(m) m.style.display = "flex";
  }
  window.closeAllowlist = function(){
    const m = document.getElementById("allowlistModal");
    if(m) m.style.display = "none";
  }
  window.addAllowedEmail = function(){
    const inp = document.getElementById("newAllowedEmail");
    if(!inp) return;
    const em = normEmail(inp.value);
    if(!em) return;
    const a = getAllowed().map(normEmail).filter(Boolean);
    if(!a.includes(em)) a.push(em);
    setAllowed(a);
    inp.value = "";
    refreshAllowedUI();
  }


  const loginBack = document.getElementById("loginBack");
  const emailEl = document.getElementById("loginEmail");
  const passEl = document.getElementById("loginPass");
  const msgEl = document.getElementById("loginMsg");
  const btnLogin = document.getElementById("btnLogin");
  const btnCreate = document.getElementById("btnCreate");
  const btnLogout = document.getElementById("btnLogout");

  function showLogin(show){
    loginBack.style.display = show ? "flex" : "none";
    if(show && !msgEl.textContent) msgEl.textContent = "";
  }

  function friendlyErr(e){
    const code = (e && e.code) ? e.code : "";
    if(code.includes("auth/invalid-credential")) return "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
    if(code.includes("auth/user-not-found")) return "Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.";
    if(code.includes("auth/wrong-password")) return "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
    if(code.includes("auth/email-already-in-use")) return "Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§.";
    if(code.includes("auth/weak-password")) return "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ©.";
    if(code.includes("auth/invalid-email")) return "Ø§Ù„Ø¨Ø±ÙŠØ¯ ØºÙŠØ± ØµØ§Ù„Ø­.";
    if(code.includes("auth/network-request-failed")) return "ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.";
    return (e && e.message) ? e.message : "Ø­Ø¯Ø« Ø®Ø·Ø£.";
  }

  // Auth guard (Firebase only) + bypass local login (admin)
  auth.onAuthStateChanged((user) => {
    // ğŸ”’ ØªÙ‚ÙŠÙŠØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    if(user && !isAllowedEmail(user.email)){
      try{ msgEl.textContent = "Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ù„Ù‡ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„."; }catch(e){}
      auth.signOut();
      showLogin(true);
      return;
    }

    const appDiv = document.getElementById("app");
    const loginCard = document.getElementById("loginCard");
    if(user){
      const btnAllow = document.getElementById("btnAllowlist");
      if(btnAllow){ btnAllow.style.display = "block"; btnAllow.onclick = openAllowlist; }
      showLogin(false);
      btnLogout.style.display = "block";
      if(loginCard) loginCard.style.display = "none";

      try{ sessionStorage.setItem("role","admin"); }catch(e){}
      if(appDiv) appDiv.style.display = "block";

      if(!window.__firebaseBooted){
        window.__firebaseBooted = true;
        try{ if(typeof bootAuthed === "function") bootAuthed(); }catch(e){}
      }
    }else{
      const btnAllow = document.getElementById("btnAllowlist");
      if(btnAllow) btnAllow.style.display = "none";
      window.__firebaseBooted = false;
      btnLogout.style.display = "none";
      if(appDiv) appDiv.style.display = "none";
      if(loginCard) loginCard.style.display = "none";
      try{ sessionStorage.removeItem("role"); }catch(e){}
      msgEl.textContent = "";
      showLogin(true);
    }
  });

  btnLogin.addEventListener("click", async () => {
    try{
      msgEl.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...";
      await auth.signInWithEmailAndPassword(emailEl.value.trim(), passEl.value);
    }catch(e){
      msgEl.textContent = friendlyErr(e);
    }
  });

  btnCreate.addEventListener("click", async () => {
    try{
      msgEl.textContent = "Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨...";
      await auth.createUserWithEmailAndPassword(emailEl.value.trim(), passEl.value);
    }catch(e){
      msgEl.textContent = friendlyErr(e);
    }
  });

  btnLogout.addEventListener("click", async () => {
    await auth.signOut();
  });
</script>
<!-- ================================================================ -->



<!-- ===== Allowlist UI (Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª Ù…Ø³Ù…ÙˆØ­ Ù„Ù‡Ø§) ===== -->
<div id="allowlistModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:99990;align-items:center;justify-content:center;padding:14px">
  <div style="width:min(520px,96vw);background:#0f172a;color:#fff;padding:16px;border-radius:16px;border:1px solid rgba(255,255,255,.12)">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
      <h3 style="margin:0;font-size:18px">Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ù„Ù‡Ø§</h3>
      <button type="button" onclick="closeAllowlist()" style="border:0;background:transparent;color:#fff;font-size:18px;cursor:pointer">âœ•</button>
    </div>
    <p style="opacity:.85;margin:8px 0 12px;font-size:13px">Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©: ÙŠØ³Ù…Ø­ Ù„Ù„Ø¬Ù…ÙŠØ¹. Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ø¥ÙŠÙ…ÙŠÙ„: ÙŠØµØ¨Ø­ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù‚ÙŠØ¯Ù‹Ø§.</p>

    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <input id="newAllowedEmail" type="email" placeholder="email@example.com"
        style="flex:1;min-width:220px;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.25);color:#fff;outline:none">
      <button type="button" onclick="addAllowedEmail()"
        style="padding:10px 14px;border-radius:10px;background:#22c55e;color:#08111f;border:0;cursor:pointer">Ø¥Ø¶Ø§ÙØ©</button>
    </div>

    <ul id="allowedList" style="margin:12px 0 0;padding-left:18px;max-height:240px;overflow:auto"></ul>
  </div>
</div>

<button id="btnAllowlist" type="button"
  style="position:fixed;bottom:14px;right:14px;z-index:9999;display:none;padding:10px 14px;border-radius:12px;background:#0ea5e9;color:#08111f;border:0;cursor:pointer">
  Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª
</button>

</body>
</html>
