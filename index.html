<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù„ÙˆØ­Ø© ØªØ³ÙŠÙŠØ± Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</title>

<style>
:root{
  --bg0:#070a12;
  --bg1:#0b1020;
  --card: rgba(255,255,255,.06);
  --line: rgba(255,255,255,.10);

  --text:#eaf0ff;
  --muted: rgba(234,240,255,.70);

  --accent:#7c5cff;
  --warn:#f59e0b;
  --err:#ef4444;

  --radius:18px;
  --shadow: 0 18px 45px rgba(0,0,0,.45);
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  color: var(--text);
  background:
    radial-gradient(1200px 650px at 85% -10%, rgba(124,92,255,.25), transparent 60%),
    radial-gradient(1000px 600px at 10% 0%, rgba(34,197,94,.18), transparent 60%),
    linear-gradient(180deg, var(--bg0), var(--bg1));
  padding: 18px;
}
.container{max-width:1200px;margin:0 auto}

.header{margin-bottom:14px}
.header h1{margin:0;font-size:20px}
.header .sub{margin-top:6px;font-size:13px;color:var(--muted);line-height:1.7}

.card{
  background: var(--card);
  border: 1px solid var(--line);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  overflow:hidden;
}

.topbar{
  padding:14px;
  border-bottom:1px solid var(--line);
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}

.btn{
  border:1px solid var(--line);
  background: rgba(0,0,0,.18);
  color: var(--text);
  padding:10px 12px;
  border-radius:14px;
  font-weight:900;
  cursor:pointer;
  transition: transform .08s ease, background .15s ease, border-color .15s ease;
}
.btn:hover{ background: rgba(255,255,255,.06); }
.btn:active{ transform: scale(.98); }
.btn.primary{
  border-color: rgba(124,92,255,.55);
  background: linear-gradient(135deg, rgba(124,92,255,.55), rgba(124,92,255,.15));
}
.btn.danger{
  border-color: rgba(239,68,68,.55);
  background: linear-gradient(135deg, rgba(239,68,68,.35), rgba(239,68,68,.12));
}
.btn.soft{
  border-color: rgba(255,255,255,.14);
  background: rgba(255,255,255,.04);
}
.btn.soft:hover{ background: rgba(255,255,255,.08); }

.searchWrap{flex:1;min-width:240px}
.searchWrap input{
  width:100%;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid var(--line);
  background: rgba(0,0,0,.18);
  color: var(--text);
  outline:none;
}
.searchWrap input:focus{
  border-color: rgba(124,92,255,.6);
  box-shadow: 0 0 0 4px rgba(124,92,255,.14);
}

.pills{margin-inline-start:auto;display:flex;gap:8px;flex-wrap:wrap}
.pill{
  font-size:12px;
  font-weight:900;
  padding:7px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background: rgba(0,0,0,.18);
  color: var(--muted);
}

/* ======= Table ======= */
.tableWrap{ overflow:auto; }
table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  min-width: 920px;
}
thead th{
  position:sticky; top:0;
  z-index:5;
  background: rgba(0,0,0,.22);
  color: var(--muted);
  text-align:right;
  font-size:12px;
  font-weight:900;
  padding:12px 12px;
  border-bottom:1px solid var(--line);
}
tbody td{
  padding:12px 12px;
  border-bottom:1px solid rgba(255,255,255,.07);
  white-space:nowrap;
  vertical-align:middle;
}
tbody tr:hover{ background: rgba(255,255,255,.03); }

tr.expired-row{ background: rgba(239,68,68,.10); }
tr.expiring-row{ background: rgba(245,158,11,.08); }
tr.expired-row td:first-child{ box-shadow: inset 4px 0 0 rgba(239,68,68,.85); }
tr.expiring-row td:first-child{ box-shadow: inset 4px 0 0 rgba(245,158,11,.85); }

.badge{
  display:inline-flex;
  align-items:center;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  font-size:12px;
  font-weight:900;
}
.badge.ok{ border-color: rgba(34,197,94,.45); color:#c8f7d9; }
.badge.warn{ border-color: rgba(245,158,11,.45); color:#ffe2b3; }
.badge.err{ border-color: rgba(239,68,68,.45); color:#ffd0d0; }

/* ======= Modals ======= */
.modal{
  position:fixed; inset:0;
  display:none;
  align-items:center; justify-content:center;
  background: rgba(0,0,0,.62);
  z-index:9999;
  padding: 18px;
}
.modal[aria-hidden="false"]{ display:flex; }
.modal .box{
  width:min(860px, 100%);
  background: rgba(10,14,26,.96);
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 22px;
  box-shadow: 0 30px 90px rgba(0,0,0,.65);
  overflow:hidden;
  animation: pop .14s ease-out;
}
@keyframes pop{ from{ transform: translateY(8px); opacity:.0 } to{ transform: translateY(0); opacity:1 } }
.modalHeader{
  padding:14px 16px;
  border-bottom:1px solid rgba(255,255,255,.10);
  display:flex; align-items:center; justify-content:space-between;
  gap:10px;
}
.modalHeader h2{margin:0;font-size:16px}
.modalHeader .hint{color:var(--muted);font-size:12px}
.modalBody{ padding: 14px 16px; }
.modalFooter{
  padding:12px 16px;
  border-top:1px solid rgba(255,255,255,.10);
  display:flex; gap:10px; flex-wrap:wrap;
  justify-content:flex-start;
}

.formGrid{
  display:grid;
  grid-template-columns: 1.2fr 1.2fr .9fr .9fr .9fr .9fr;
  gap:10px;
}
@media (max-width: 980px){
  table{min-width: 860px}
  .formGrid{ grid-template-columns: 1fr 1fr; }
}
.field label{
  display:block;
  font-weight:900;
  font-size:12px;
  color: var(--muted);
  margin-bottom:6px;
}
.field input, .field select, .field textarea{
  width:100%;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.22);
  color: var(--text);
  outline:none;
}
.field input:focus, .field select:focus, .field textarea:focus{
  border-color: rgba(124,92,255,.6);
  box-shadow: 0 0 0 4px rgba(124,92,255,.14);
}

/* Backup modal layout */
.backGrid{
  display:grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap:10px;
}
@media (max-width: 760px){
  .backGrid{ grid-template-columns: 1fr; }
}
.backTile{
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.03);
  border-radius:18px;
  padding:12px;
}
.backTile .t{font-weight:900;margin-bottom:6px}
.backTile .d{color:var(--muted);font-size:12px;line-height:1.6;margin-bottom:10px}
.backTile .actions{display:flex;gap:10px;flex-wrap:wrap}

.note{
  margin-top:10px;
  border:1px dashed rgba(255,255,255,.14);
  background: rgba(0,0,0,.14);
  border-radius:16px;
  padding:10px 12px;
  color:var(--muted);
  font-size:12px;
  line-height:1.7;
}
.hidden{display:none}

/* ===== Actions Modal (Ù„Ù„Ø¬Ø¯ÙˆÙ„ ÙÙ‚Ø·) ===== */
.actionPill{
  padding:10px 12px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  color: var(--text);
  font-weight: 900;
  cursor:pointer;
}
.actionPill:hover{ background: rgba(255,255,255,.08); }

.actGrid{
  display:grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap:12px;
}
@media (max-width: 640px){
  .actGrid{ grid-template-columns: 1fr; }
}
.actBtn{
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  color: var(--text);
  padding: 14px 14px;
  border-radius: 18px;
  font-weight: 900;
  cursor:pointer;
  min-height: 56px;
}
.actBtn:hover{ background: rgba(255,255,255,.08); }
.actBtn:active{ transform: scale(.99); }
.actBtn.danger{
  border-color: rgba(239,68,68,.45);
  background: rgba(239,68,68,.20);
}
.actBtn.danger:hover{ background: rgba(239,68,68,.28); }

/* ===== Sync Modal UI (Ù…Ø«Ù„ Ø§Ù„ØµÙˆØ±Ø©) ===== */
.syncSectionTitle{
  font-weight: 900;
  margin: 2px 0 10px;
  color: var(--muted);
}
.syncGrid{
  display:grid;
  grid-template-columns: 1fr;
  gap:12px;
}
.syncBtn{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  padding:16px 14px;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  color: var(--text);
  font-weight: 900;
  cursor:pointer;
  text-decoration:none;
}
.syncBtn:hover{ background: rgba(255,255,255,.08); }
.syncBtn:active{ transform: scale(.99); }
.syncBtn.link{ cursor:pointer; }

.syncHr{
  height:1px;
  background: rgba(255,255,255,.10);
  margin: 14px 0;
}
.syncNote{
  margin-top: 14px;
  border:1px dashed rgba(255,255,255,.16);
  background: rgba(0,0,0,.16);
  border-radius:16px;
  padding:10px 12px;
  color: var(--muted);
  font-size:12px;
  line-height:1.7;
}
</style>
</head>

<body>
<div class="container">
  <div class="header">
    <h1>ğŸ§¾ Ù„ÙˆØ­Ø© ØªØ³ÙŠÙŠØ± Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</h1>
    <div class="sub">âš¡ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù„Ù„ØµÙ + â˜ï¸ Ù†Ø§ÙØ°Ø© Ù…Ø²Ø§Ù…Ù†Ø©/Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ.</div>
  </div>

  <div class="card">
    <div class="topbar">
      <button class="btn primary" id="openAdd" type="button">â• Ø¥Ø¶Ø§ÙØ©</button>
      <button class="btn soft" id="openBackup" type="button">ğŸ“¦ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</button>
      <button class="btn soft" id="openSync" type="button">â˜ï¸ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</button>

      <div class="searchWrap">
        <input id="search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„..." />
      </div>

      <button class="btn danger" id="clearBtn" type="button">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>

      <div class="pills">
        <div class="pill" id="statsPill">â€”</div>
      </div>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>Ø§Ù„Ø§Ø³Ù…</th>
            <th>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</th>
            <th>Ø§Ù„Ù…Ø¯Ø©</th>
            <th>Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th>
            <th>Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th>
            <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal: Add/Edit -->
<div class="modal" id="formModal" aria-hidden="true">
  <div class="box" role="dialog" aria-modal="true">
    <div class="modalHeader">
      <div>
        <h2 id="formTitle">Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ùƒ</h2>
        <div class="hint">Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø«Ù… Ø§Ø¶ØºØ· Ø­ÙØ¸</div>
      </div>
      <button class="btn" id="closeForm" type="button">âœ• Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <div class="modalBody">
      <div class="formGrid">
        <div class="field">
          <label>Ø§Ù„Ø§Ø³Ù…</label>
          <input id="name" placeholder="Ù…Ø«Ø§Ù„: Ahmed">
        </div>
        <div class="field">
          <label>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label>
          <input id="email" placeholder="name@example.com" inputmode="email">
        </div>
        <div class="field">
          <label>Ø§Ø®ØªÙŠØ§Ø± Ø³Ø±ÙŠØ¹</label>
          <select id="quickPlan">
            <option value="">â€” Ø§Ø®ØªØ± â€”</option>
            <option value="1">1 Ø´Ù‡Ø±</option>
            <option value="3">3 Ø£Ø´Ù‡Ø±</option>
            <option value="6">6 Ø£Ø´Ù‡Ø±</option>
            <option value="12">12 Ø´Ù‡Ø±</option>
          </select>
        </div>
        <div class="field">
          <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ù‡Ø± (Ø£ÙŠ Ø±Ù‚Ù…)</label>
          <input id="months" type="number" min="1" step="1" placeholder="Ù…Ø«Ø§Ù„: 2 / 5 / 18">
        </div>
        <div class="field">
          <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</label>
          <input id="start" type="date">
        </div>
        <div class="field">
          <label>ØªÙ†Ø¨ÙŠÙ‡ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (Ø£ÙŠØ§Ù…)</label>
          <input id="alertDays" type="number" min="1" step="1" placeholder="Ù…Ø«Ø§Ù„: 7">
        </div>
      </div>
    </div>

    <div class="modalFooter">
      <button class="btn primary" id="saveBtn" type="button">ğŸ’¾ Ø­ÙØ¸</button>
      <button class="btn" id="cancelBtn" type="button">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<!-- Modal: Backup -->
<div class="modal" id="backupModal" aria-hidden="true">
  <div class="box" role="dialog" aria-modal="true">
    <div class="modalHeader">
      <div>
        <h2>ğŸ“¦ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h2>
        <div class="hint">ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON Ùˆ CSV + Ù„ØµÙ‚ JSON</div>
      </div>
      <button class="btn" id="closeBackup" type="button">âœ• Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <div class="modalBody">
      <div class="backGrid">
        <div class="backTile">
          <div class="t">â¬‡ï¸ ØªØµØ¯ÙŠØ± JSON</div>
          <div class="d">Ø£ÙØ¶Ù„ Ø®ÙŠØ§Ø± Ù„Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ÙƒØ§Ù…Ù„.</div>
          <div class="actions">
            <button class="btn soft" id="exportJsonBtn" type="button">ØªØµØ¯ÙŠØ±</button>
          </div>
        </div>

        <div class="backTile">
          <div class="t">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù JSON</div>
          <div class="d">Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.</div>
          <div class="actions">
            <button class="btn soft" id="importFileBtn" type="button">Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</button>
            <input id="fileInput" type="file" accept="application/json,.json" class="hidden">
          </div>
        </div>

        <div class="backTile">
          <div class="t">ğŸ“‹ Ù„ØµÙ‚ JSON</div>
          <div class="d">Ø§Ù„ØµÙ‚ JSON ÙˆØ§Ø³ØªÙˆØ±Ø¯ Ù…Ø¨Ø§Ø´Ø±Ø©.</div>
          <div class="actions">
            <button class="btn soft" id="openPasteFromBackup" type="button">ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù„ØµÙ‚</button>
          </div>
        </div>

        <div class="backTile">
          <div class="t">â¬‡ï¸ ØªØµØ¯ÙŠØ± CSV</div>
          <div class="d">Ù„Ù„Ø¹Ø±Ø¶ ÙÙŠ Excel (Ù…Ø±Ø§Ø¬Ø¹Ø©).</div>
          <div class="actions">
            <button class="btn soft" id="exportCsvBtn" type="button">ØªØµØ¯ÙŠØ±</button>
          </div>
        </div>
      </div>

      <div class="note">
        <b>Ù…Ù„Ø§Ø­Ø¸Ø©:</b> Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙŠØªÙ… Ø§Ù„Ø¯Ù…Ø¬ Ø­Ø³Ø¨ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±.
      </div>
    </div>

    <div class="modalFooter">
      <button class="btn" id="closeBackup2" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<!-- Modal: Paste JSON -->
<div class="modal" id="pasteModal" aria-hidden="true">
  <div class="box" role="dialog" aria-modal="true">
    <div class="modalHeader">
      <div>
        <h2>ğŸ“‹ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ø§Ù„Ù„ØµÙ‚ (JSON)</h2>
        <div class="hint">Ø§Ù„ØµÙ‚ JSON Ø«Ù… Ø§Ø¶ØºØ· Ø§Ø³ØªÙŠØ±Ø§Ø¯</div>
      </div>
      <button class="btn" id="closePaste" type="button">âœ• Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <div class="modalBody">
      <div class="field">
        <label>JSON</label>
        <textarea id="pasteArea" rows="10" style="min-height:220px"></textarea>
      </div>
    </div>

    <div class="modalFooter">
      <button class="btn primary" id="doPasteImport" type="button">Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
      <button class="btn" id="cancelPaste" type="button">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<!-- ===== Modal: Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„ ===== -->
<div class="modal" id="rowActionsModal" aria-hidden="true">
  <div class="box" role="dialog" aria-modal="true" style="width:min(740px, 100%)">
    <div class="modalHeader">
      <div>
        <h2>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</h2>
        <div class="hint" id="rowActionsHint">â€”</div>
      </div>
      <button class="btn" id="closeRowActionsX" type="button">âœ•</button>
    </div>

    <div class="modalBody">
      <div class="actGrid">
        <button class="actBtn" id="actExtend" type="button">ğŸ” ØªØ¬Ø¯ÙŠØ¯</button>
        <button class="actBtn" id="actEdit" type="button">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="actBtn" id="actCopyEmail" type="button">ğŸ“‹ Ù†Ø³Ø® Email</button>
        <button class="actBtn danger" id="actDelete" type="button">ğŸ—‘ï¸ Ø­Ø°Ù</button>
      </div>
    </div>

    <div class="modalFooter">
      <button class="btn" id="closeRowActions" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<!-- ===== Modal: Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ÙˆØ§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ===== -->
<div class="modal" id="syncModal" aria-hidden="true">
  <div class="box" role="dialog" aria-modal="true" style="width:min(760px, 100%)">
    <div class="modalHeader">
      <div>
        <h2>â˜ï¸ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ÙˆØ§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h2>
        <div class="hint">Ø§Ù„Ù†Ø³Ø® ÙˆØ§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ + Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØªØ®Ø²ÙŠÙ†</div>
      </div>
      <button class="btn" id="closeSyncX" type="button">âœ•</button>
    </div>

    <div class="modalBody">
      <div class="syncSectionTitle">ğŸ“¦ Ø§Ù„Ù†Ø³Ø® ÙˆØ§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹</div>

      <div class="syncGrid">
        <button class="syncBtn" id="syncBackupDownload" type="button">ğŸ’¾ Backup (ØªÙ†Ø²ÙŠÙ„)</button>
        <button class="syncBtn" id="syncBackupShare" type="button">ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ© Backup</button>
        <button class="syncBtn" id="syncRestorePick" type="button">ğŸ“¥ Restore (Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù)</button>
      </div>

      <div class="syncHr"></div>

      <div class="syncSectionTitle">â˜ï¸ Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØªØ®Ø²ÙŠÙ†</div>
      <div class="syncGrid">
        <a class="syncBtn link" href="https://drive.google.com/" target="_blank" rel="noopener">ğŸ“‚ ÙØªØ­ Google Drive</a>
        <a class="syncBtn link" href="https://www.dropbox.com/" target="_blank" rel="noopener">ğŸ“‚ ÙØªØ­ Dropbox</a>
      </div>

      <div class="syncNote">
        <b>Ù…Ù„Ø§Ø­Ø¸Ø©:</b> Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ø¯ÙˆÙ† Ø³ÙŠØ±ÙØ±: Ø£Ù†Ø´Ø¦ Ù…Ù„Ù <b>backup.json</b> Ø«Ù… Ø´Ø§Ø±ÙƒÙ‡/Ø§Ø±ÙÙØ¹Ù’Ù‡ Ø¥Ù„Ù‰ Drive/DropboxØŒ
        ÙˆØ¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ.
      </div>
    </div>

    <div class="modalFooter">
      <button class="btn" id="closeSync" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<script>
const $ = (id)=>document.getElementById(id);
const FIREBASE_URL  = "https://dattta-6f497-default-rtdb.firebaseio.com";
const FIREBASE_PATH = "subscriptions"; // Ù…Ø³Ø§Ø± Ø§Ù„ØªØ®Ø²ÙŠÙ† ÙÙŠ Firebase
const LOCAL_BACKUP_KEY = "subs_local_backup_v3";

let syncState = "idle"; // idle | saving | ok | fail | offline
let lastSyncAt = null;
let statsBaseText = "â€”";

/* Ù…Ø¤Ø´Ø± Ø¨ØµØ±ÙŠ Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ */
function setSyncState(state){
  syncState = state;

  const pill = $("statsPill");
  if(!pill) return;

  let s = "";
  if(!navigator.onLine){
    s = " | ğŸ“´ Ø£ÙˆÙÙ„Ø§ÙŠÙ†";
  }else if(state === "saving"){
    s = " | â³ Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸...";
  }else if(state === "ok"){
    s = ` | âœ… ØªÙ… (${lastSyncAt || ""})`;
  }else if(state === "fail"){
    s = " | ğŸ”´ ÙØ´Ù„";
  }else{
    s = "";
  }

  pill.textContent = statsBaseText + s;
}

function nowHHMM(){
  const d = new Date();
  const hh = String(d.getHours()).padStart(2,"0");
  const mm = String(d.getMinutes()).padStart(2,"0");
  return `${hh}:${mm}`;
}

function saveLocalBackup(){
  try{ localStorage.setItem(LOCAL_BACKUP_KEY, JSON.stringify(data)); }catch{}
}
function loadLocalBackup(){
  try{
    const raw = localStorage.getItem(LOCAL_BACKUP_KEY);
    const j = raw ? JSON.parse(raw) : null;
    return Array.isArray(j) ? j : [];
  }catch{ return []; }
}

async function firebasePull(){
  const res = await fetch(`${FIREBASE_URL}/${FIREBASE_PATH}.json`, { cache: "no-store" });
  if(!res.ok) throw new Error("Firebase pull failed");
  const json = await res.json();
  return Array.isArray(json) ? json : (json ? json : []);
}

async function firebasePush(){
  const res = await fetch(`${FIREBASE_URL}/${FIREBASE_PATH}.json`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });
  if(!res.ok) throw new Error("Firebase push failed");
}

/* Ù…Ø²Ø§Ù…Ù†Ø© ÙÙˆØ±ÙŠØ© Ø¨Ø¯ÙˆÙ† ØªØ£Ø®ÙŠØ± */
async function syncPushNow(){
  saveLocalBackup();
  if(!navigator.onLine){ setSyncState("offline"); return; }
  try{
    setSyncState("saving");
    await firebasePush();
    lastSyncAt = nowHHMM();
    setSyncState("ok");
  }catch{
    setSyncState("fail");
  }
}

async function syncPullNow(){
  if(!navigator.onLine){ setSyncState("offline"); return; }
  try{
    setSyncState("saving");
    data = await firebasePull();
    saveLocalBackup();
    lastSyncAt = nowHHMM();
    setSyncState("ok");
    render();
  }catch{
    setSyncState("fail");
  }
}

window.addEventListener("online", ()=> setSyncState(syncState));
window.addEventListener("offline", ()=> setSyncState("offline"));


const STORAGE_KEY = "subs_dashboard_actions_modal_v2";
const SETTINGS_KEY = "subs_dashboard_actions_modal_settings_v2";

let data = [];
let editingId = null;

/* ===== Utils ===== */
function todayISO(){
  const d=new Date(); d.setHours(0,0,0,0);
  return d.toISOString().slice(0,10);
}
function toDate(iso){
  const d=new Date(iso+"T00:00:00"); d.setHours(0,0,0,0);
  return d;
}
function addMonths(dateISO, m){
  const d=toDate(dateISO);
  const day=d.getDate();
  d.setMonth(d.getMonth()+m);
  if(d.getDate() < day) d.setDate(0);
  return d.toISOString().slice(0,10);
}
function normalizeEmail(e){ return (e||"").trim().toLowerCase(); }
function validateEmail(e){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e); }
function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}
function daysLeft(endISO){
  const now=toDate(todayISO());
  const end=toDate(endISO);
  return Math.round((end-now)/(1000*60*60*24));
}

/* alertDays stored */
function getStoredAlertDays(){
  try{
    const s = JSON.parse(localStorage.getItem(SETTINGS_KEY)||"{}");
    const a = Number(s.alertDays);
    return (a && a>0) ? a : 7;
  }catch{ return 7; }
}
function setStoredAlertDays(n){
  localStorage.setItem(SETTINGS_KEY, JSON.stringify({alertDays:n}));
}
function getAlertDaysFromForm(){
  const n = Number($("alertDays").value);
  return (n && n>0) ? n : 7;
}
function status(endISO, alertDays){
  const left=daysLeft(endISO);
  if(left < 0) return {key:"expired", label:"Ù…Ù†ØªÙ‡ÙŠ", cls:"err", left};
  if(left <= alertDays) return {key:"expiring", label:"Ù‚Ø±ÙŠØ¨ ÙŠÙ†ØªÙ‡ÙŠ", cls:"warn", left};
  return {key:"active", label:"ÙØ¹Ù‘Ø§Ù„", cls:"ok", left};
}

/* ===== Storage ===== */
async function load(){
  // Ø£ÙˆÙ„ÙˆÙŠØ©: Firebase Ø«Ù… Ù†Ø³Ø®Ø© Ù…Ø­Ù„ÙŠØ©
  if(navigator.onLine){
    try{
      setSyncState("saving");
      data = await firebasePull();
      saveLocalBackup();
      lastSyncAt = nowHHMM();
      setSyncState("ok");
      return;
    }catch{
      setSyncState("fail");
    }
  }else{
    setSyncState("offline");
  }

  data = loadLocalBackup();
  setSyncState(syncState);
}

function save(){
  // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ + Ù…Ø²Ø§Ù…Ù†Ø© ÙÙˆØ±ÙŠØ© (Ù„Ø§ Ù†Ù†ØªØ¸Ø±)
  syncPushNow();
}
/* ===== Modals ===== */
function openModal(id){
  $(id).setAttribute("aria-hidden","false");
}
function closeModal(id){
  $(id).setAttribute("aria-hidden","true");
}
function closeAllModals(){
  ["formModal","backupModal","pasteModal","rowActionsModal","syncModal"].forEach(closeModal);
}

/* close on background click */
["formModal","backupModal","pasteModal","rowActionsModal","syncModal"].forEach(mid=>{
  $(mid).addEventListener("click",(e)=>{
    if(e.target.id===mid) closeModal(mid);
  });
});

/* Esc closes */
document.addEventListener("keydown",(e)=>{
  if(e.key==="Escape"){
    closeAllModals();
  }
});

/* ===== vibration helper ===== */
function vibrateLight(){
  try{ if (navigator.vibrate) navigator.vibrate(20); }catch{}
}

/* ===== Form modal ===== */
function resetForm(){
  $("name").value="";
  $("email").value="";
  $("quickPlan").value="";
  $("months").value="";
  $("start").value=todayISO();
  $("alertDays").value=getStoredAlertDays();
  editingId=null;
  $("formTitle").textContent="Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ùƒ";
}
function fillForm(rec){
  editingId = rec.id;
  $("formTitle").textContent="ØªØ¹Ø¯ÙŠÙ„ Ø§Ø´ØªØ±Ø§Ùƒ";
  $("name").value = rec.name || "";
  $("email").value = rec.email || "";
  $("months").value = rec.months || "";
  $("start").value = rec.start || todayISO();
  $("quickPlan").value = ["1","3","6","12"].includes(String(rec.months)) ? String(rec.months) : "";
  $("alertDays").value = getStoredAlertDays();
}

$("openAdd").onclick = ()=>{ resetForm(); openModal("formModal"); };
$("closeForm").onclick = ()=> closeModal("formModal");
$("cancelBtn").onclick = ()=> closeModal("formModal");

$("quickPlan").onchange = ()=>{
  const v = $("quickPlan").value;
  if(v) $("months").value = v;
};

/* ===== Backup modal ===== */
$("openBackup").onclick = ()=> openModal("backupModal");
$("closeBackup").onclick = ()=> closeModal("backupModal");
$("closeBackup2").onclick = ()=> closeModal("backupModal");

/* ===== Sync modal ===== */
$("openSync").onclick = ()=> openModal("syncModal");
$("closeSyncX").onclick = ()=> closeModal("syncModal");
$("closeSync").onclick  = ()=> closeModal("syncModal");

/* ===== Paste modal ===== */
$("openPasteFromBackup").onclick = ()=>{
  $("pasteArea").value="";
  openModal("pasteModal");
};
$("closePaste").onclick = ()=> closeModal("pasteModal");
$("cancelPaste").onclick = ()=> closeModal("pasteModal");

/* ===== Top actions ===== */
$("search").addEventListener("input", render);

$("clearBtn").onclick = ()=>{
  if(!confirm("Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ")) return;
  data=[]; save(); render();
};

/* ===== Upsert record (merge by email) ===== */
function upsert(rec){
  const idxByEmail = data.findIndex(r=>normalizeEmail(r.email)===normalizeEmail(rec.email));

  if(editingId){
    const idxById = data.findIndex(r=>r.id===editingId);
    if(idxById>=0){
      if(idxByEmail>=0 && idxByEmail!==idxById){
        data[idxByEmail] = {...data[idxByEmail], ...rec, id:data[idxByEmail].id};
        data.splice(idxById,1);
      }else{
        data[idxById] = {...data[idxById], ...rec, id:editingId};
      }
      return;
    }
  }
  if(idxByEmail>=0){
    data[idxByEmail] = {...data[idxByEmail], ...rec, id:data[idxByEmail].id};
  }else{
    data.unshift(rec);
  }
}

/* Save from form */
function handleSaveClick(){
  const name = $("name").value.trim();
  const email = normalizeEmail($("email").value);
  const months = Number($("months").value);
  const start = $("start").value;
  const alertDays = getAlertDaysFromForm();

  if(!name) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…");
  if(!email || !validateEmail(email)) return alert("Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ØºÙŠØ± ØµØ­ÙŠØ­");
  if(!start) return alert("Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©");
  if(!months || months<1) return alert("Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ù‡Ø±");

  setStoredAlertDays(alertDays);

  const end = addMonths(start, months);
  const rec = {
    id: editingId || (Date.now()+"_"+Math.random().toString(16).slice(2)),
    name, email, months, start, end
  };

  upsert(rec);
  save();
  render();
  closeModal("formModal");
}

(function bindSaveButton(){
  const btn = $("saveBtn");
  if(!btn) return;
  const fire = (e)=>{
    try{ e.preventDefault(); }catch{}
    handleSaveClick();
  };
  btn.addEventListener("click", fire);
  // Ø¹Ù„Ù‰ Ø¨Ø¹Ø¶ Ù‡ÙˆØ§ØªÙ Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ Ø£ÙˆÙ„ Ù†Ù‚Ø±Ø© ØªØ²ÙŠÙ„ Ø§Ù„ØªØ±ÙƒÙŠØ² ÙÙ‚Ø·ØŒ Ù„Ø°Ù„Ùƒ Ù†Ù„ØªÙ‚Ø· touchend Ø£ÙŠØ¶Ù‹Ø§
  btn.addEventListener("touchend", (e)=>{ fire(e); }, {passive:false});
})();

/* ===== Backup helpers ===== */
function downloadFile(filename, content, mime){
  const blob=new Blob([content],{type:mime});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download=filename;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

function buildBackupPayload(){
  return {
    version: 1,
    exportedAt: new Date().toISOString(),
    alertDays: getStoredAlertDays(),
    data
  };
}

$("exportJsonBtn").onclick = ()=>{
  const payload = buildBackupPayload();
  downloadFile("subscriptions_backup.json", JSON.stringify(payload,null,2), "application/json;charset=utf-8");
};

$("importFileBtn").onclick = ()=> $("fileInput").click();
$("fileInput").addEventListener("change", async ()=>{
  const f=$("fileInput").files[0];
  $("fileInput").value="";
  if(!f) return;
  importFromText(await f.text());
});

$("doPasteImport").onclick = ()=> importFromText($("pasteArea").value);

function importFromText(text){
  const raw=(text||"").trim();
  if(!raw) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ JSON");

  let incoming;
  try{ incoming = JSON.parse(raw); }
  catch{ alert("JSON ØºÙŠØ± ØµØ§Ù„Ø­"); return; }

  const importedData = Array.isArray(incoming) ? incoming : incoming.data;
  if(!Array.isArray(importedData)){ alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª"); return; }

  if(incoming && typeof incoming.alertDays==="number" && incoming.alertDays>0){
    setStoredAlertDays(incoming.alertDays);
  }

  let added=0, updated=0;
  for(const r of importedData){
    if(!r || !r.email) continue;
    const email = normalizeEmail(r.email);
    if(!email || !validateEmail(email)) continue;

    const months = Number(r.months||1);
    const start = r.start || todayISO();
    const end = r.end || addMonths(start, months);

    const rec = {
      id: r.id || (Date.now()+"_"+Math.random().toString(16).slice(2)),
      name: (r.name||"").trim(),
      email, months, start, end
    };

    const idx = data.findIndex(x=>normalizeEmail(x.email)===email);
    if(idx>=0){ data[idx] = {...data[idx], ...rec, id:data[idx].id}; updated++; }
    else { data.unshift(rec); added++; }
  }

  save(); render();
  closeModal("pasteModal");
  alert(`ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ âœ…\nØ¥Ø¶Ø§ÙØ©: ${added}\nØªØ­Ø¯ÙŠØ«: ${updated}`);
}

$("exportCsvBtn").onclick = ()=>{
  const header=["name","email","months","start","end"];
  const lines=[header.join(",")];
  for(const r of data){
    lines.push([csvCell(r.name),csvCell(r.email),csvCell(r.months),csvCell(r.start),csvCell(r.end)].join(","));
  }
  downloadFile("subscriptions.csv", lines.join("\n"), "text/csv;charset=utf-8");
};
function csvCell(v){
  const s=String(v??"");
  if(/[,"\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
  return s;
}

/* ===== Actions Modal (Ù„Ù„Ø¬Ø¯ÙˆÙ„ ÙÙ‚Ø·) ===== */
let currentRowId = null;

function openRowActions(id){
  currentRowId = id;
  const rec = data.find(x => x.id === id);
  if(!rec) return;
  $("rowActionsHint").textContent = `${rec.name} â€” ${rec.email}`;
  openModal("rowActionsModal");
  vibrateLight();
}
function closeRowActions(){
  closeModal("rowActionsModal");
  currentRowId = null;
}
$("closeRowActionsX").onclick = closeRowActions;
$("closeRowActions").onclick  = closeRowActions;

$("actEdit").onclick = ()=>{
  const rec = data.find(x => x.id === currentRowId);
  if(!rec) return;
  closeRowActions();
  fillForm(rec);
  openModal("formModal");
};

$("actExtend").onclick = ()=>{
  const rec = data.find(x => x.id === currentRowId);
  if(!rec) return;
  rec.end = addMonths(rec.end, Number(rec.months));
  save();
  render();
  closeRowActions();
};

$("actDelete").onclick = ()=>{
  const rec = data.find(x => x.id === currentRowId);
  if(!rec) return;

  if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ")) return;
  data = data.filter(x => x.id !== currentRowId);
  save();
  render();
  closeRowActions();
};

$("actCopyEmail").onclick = async ()=>{
  const rec = data.find(x => x.id === currentRowId);
  if(!rec) return;

  const text = rec.email || "";
  try{
    await navigator.clipboard.writeText(text);
    vibrateLight();
    alert("âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„");
  }catch{
    const tmp = document.createElement("textarea");
    tmp.value = text;
    document.body.appendChild(tmp);
    tmp.select();
    document.execCommand("copy");
    tmp.remove();
    vibrateLight();
    alert("âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„");
  }
};

/* ===== Sync modal buttons ===== */
$("syncBackupDownload").onclick = ()=> syncPushNow();

$("syncRestorePick").onclick = ()=> syncPullNow();

$("syncBackupShare").onclick = async ()=>{
  const payload = buildBackupPayload();
  const text = JSON.stringify(payload, null, 2);
  const blob = new Blob([text], {type:"application/json"});
  const file = new File([blob], "backup.json", {type:"application/json"});

  try{
    if(navigator.share && navigator.canShare && navigator.canShare({files:[file]})){
      await navigator.share({title:"Backup", text:"backup.json", files:[file]});
      vibrateLight();
      return;
    }
  }catch{}

  // fallback: ØªÙ†Ø²ÙŠÙ„
  downloadFile("backup.json", text, "application/json;charset=utf-8");
  alert("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù (backup.json) ÙˆØªÙ†Ø²ÙŠÙ„Ù‡");
};

/* ===== Table click handling ===== */
$("tbody").addEventListener("click",(e)=>{
  const btn = e.target.closest("button[data-act]");
  if(!btn) return;

  const act = btn.getAttribute("data-act");
  const id  = btn.getAttribute("data-id");

  if(act === "actions"){
    openRowActions(id);
    return;
  }
});

/* ===== Render ===== */
function render(){
  const q = ($("search").value||"").trim().toLowerCase();
  const tb = $("tbody");
  tb.innerHTML="";

  const alertDays = getStoredAlertDays();

  const allCounts={active:0, expiring:0, expired:0};
  for(const r of data){
    allCounts[status(r.end, alertDays).key]++;
  }

  const rows = data.filter(r=>{
    if(!q) return true;
    return (r.name||"").toLowerCase().includes(q) || normalizeEmail(r.email).includes(q);
  });

  for(const r of rows){
    const st = status(r.end, alertDays);
    const tr = document.createElement("tr");
    if(st.key==="expired") tr.classList.add("expired-row");
    if(st.key==="expiring") tr.classList.add("expiring-row");

    const leftTxt = st.left < 0 ? `Ø§Ù†ØªÙ‡Ù‰ Ù…Ù†Ø° ${Math.abs(st.left)} ÙŠÙˆÙ…` : `${st.left} ÙŠÙˆÙ…`;

    tr.innerHTML = `
      <td>${escapeHtml(r.name)}</td>
      <td>${escapeHtml(r.email)}</td>
      <td>${r.months} Ø´Ù‡Ø±</td>
      <td>${r.start}</td>
      <td>${r.end}</td>
      <td>${leftTxt}</td>
      <td><span class="badge ${st.cls}">${st.label}</span></td>
      <td>
        <button class="actionPill" data-act="actions" data-id="${r.id}" type="button">âš¡ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</button>
      </td>
    `;
    tb.appendChild(tr);
  }

  statsBaseText = `Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶: ${rows.length} | Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${data.length} | ÙØ¹Ù‘Ø§Ù„: ${allCounts.active} | Ù‚Ø±ÙŠØ¨: ${allCounts.expiring} | Ù…Ù†ØªÙ‡ÙŠ: ${allCounts.expired}`;
  setSyncState(syncState);
}

/* init */
(async ()=>{
  await load();
  render();
})();
</script>
</body>
</html>
